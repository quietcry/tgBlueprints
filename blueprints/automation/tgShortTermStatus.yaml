



blueprint:
  name: Kurzzeitstatus
  description: Verwaltet einen Kurzzeitstatus mit mehreren Buttons und automatischem Timer
  domain: automation
  input:
    input_text_status:
      name: Input Text - Status
      description: Input Text Entity für den Status-Text
      default: "-"
      selector:
        entity:
          domain: input_text
    debugmode:
      name: Debug-Modus
      description: Aktiviert Debug-Ausgaben für Fehlersuche
      default: false
      selector:
        boolean:
    status_1:
      name: Status 1
      collapsed: true
      description: Einstellungen für den ersten Status
      input:
        entities_1:
          name: Entitäten
          description: Input Boolean oder Switch Entitäten für diesen Status
          default: "-"
          selector:
            entity:
              multiple: true
              domain:
                - input_boolean
                - switch
        timer_1:
          name: Timer
          description: Timer Entity
          default: "-"
          selector:
            entity:
              domain: timer
        statustext_1:
          name: Status-Text
          description: Text der angezeigt wird, wenn dieser Status aktiv ist
          default: "-"
          selector:
            text:
        duration_1:
          name: Timer-Dauer
          description: "Dauer des Timers (Standard: 30 Minuten)"
          default: "00:30:00"
          selector:
            duration:
    status_2:
      name: Status 2
      collapsed: true
      description: Einstellungen für den zweiten Status
      input:
        entities_2:
          name: Entitäten
          description: Input Boolean oder Switch Entitäten für diesen Status
          default: "-"
          selector:
            entity:
              multiple: true
              domain:
                - input_boolean
                - switch
        timer_2:
          name: Timer
          description: Timer Entity
          default: "-"
          selector:
            entity:
              domain: timer
        statustext_2:
          name: Status-Text
          description: Text der angezeigt wird, wenn dieser Status aktiv ist
          default: "-"
          selector:
            text:
        duration_2:
          name: Timer-Dauer
          description: "Dauer des Timers (Standard: 30 Minuten)"
          default: "00:30:00"
          selector:
            duration:
    status_3:
      name: Status 3
      collapsed: true
      description: Einstellungen für den dritten Status
      input:
        entities_3:
          name: Entitäten
          description: Input Boolean oder Switch Entitäten für diesen Status
          default: "-"
          selector:
            entity:
              multiple: true
              domain:
                - input_boolean
                - switch
        timer_3:
          name: Timer
          description: Timer Entity
          default: "-"
          selector:
            entity:
              domain: timer
        statustext_3:
          name: Status-Text
          description: Text der angezeigt wird, wenn dieser Status aktiv ist
          default: "-"
          selector:
            text:
        duration_3:
          name: Timer-Dauer
          description: "Dauer des Timers (Standard: 30 Minuten)"
          default: "00:30:00"
          selector:
            duration:
    status_4:
      name: Status 4
      collapsed: true
      description: Einstellungen für den vierten Status
      input:
        entities_4:
          name: Entitäten
          description: Input Boolean oder Switch Entitäten für diesen Status
          default: "-"
          selector:
            entity:
              multiple: true
              domain:
                - input_boolean
                - switch
        timer_4:
          name: Timer
          description: Timer Entity
          default: "-"
          selector:
            entity:
              domain: timer
        statustext_4:
          name: Status-Text
          description: Text der angezeigt wird, wenn dieser Status aktiv ist
          default: "-"
          selector:
            text:
        duration_4:
          name: Timer-Dauer
          description: "Dauer des Timers (Standard: 30 Minuten)"
          default: "00:30:00"
          selector:
            duration:
    status_5:
      name: Status 5
      collapsed: true
      description: Einstellungen für den fünften Status
      input:
        entities_5:
          name: Entitäten
          description: Input Boolean oder Switch Entitäten für diesen Status
          default: "-"
          selector:
            entity:
              multiple: true
              domain:
                - input_boolean
                - switch
        timer_5:
          name: Timer
          description: Timer Entity
          default: "-"
          selector:
            entity:
              domain: timer
        statustext_5:
          name: Status-Text
          description: Text der angezeigt wird, wenn dieser Status aktiv ist
          default: "-"
          selector:
            text:
        duration_5:
          name: Timer-Dauer
          description: "Dauer des Timers (Standard: 30 Minuten)"
          default: "00:30:00"
          selector:
            duration:
  
  

variables:
  statusfield: !input input_text_status
  
  tmp_states:
    - name: status_1
      buttons: !input entities_1
      timer: !input timer_1
      statustext: !input statustext_1
      duration: !input duration_1
    - name: status_2
      buttons: !input entities_2
      timer: !input timer_2
      statustext: !input statustext_2
      duration: !input duration_2
    - name: status_3
      buttons: !input entities_3
      timer: !input timer_3
      statustext: !input statustext_3
      duration: !input duration_3
    - name: status_4
      buttons: !input entities_4
      timer: !input timer_4
      statustext: !input statustext_4
      duration: !input duration_4
    - name: status_5
      buttons: !input entities_5
      timer: !input timer_5
      statustext: !input statustext_5
      duration: !input duration_5
  
  setted_states: >-
    {% set ns = namespace(result=[], filtered_buttons=[]) %}
    {% for state in tmp_states %}
      {% set buttons_list = state.buttons if state.buttons is iterable and state.buttons is not string else [state.buttons] if state.buttons is defined else [] %}
      {% set ns.filtered_buttons = [] %}
      {% for button in buttons_list %}
        {% if button != '-' and button != '' and states(button) != "unknown" %}
          {% set ns.filtered_buttons = ns.filtered_buttons + [button] %}
        {% endif %}
      {% endfor %}
      {% if ns.filtered_buttons | length > 0 %}
        {% set statustext_value = state.statustext if state.statustext and state.statustext != '' and state.statustext != '-' else '' %}
        {% set normalized_state = dict(state, **{'buttons': ns.filtered_buttons, "name": state.name, "statustext": statustext_value}) %}
        {% if state.timer and state.timer != '-' and state.timer != '' and states(state.timer) != "unknown" %}
          {% set normalized_state = dict(normalized_state, **{'timer': state.timer}) %}
        {% endif %}
        {% if state.duration and state.duration != '-' and state.duration != '' and state.duration is match('^\\d{2}:\\d{2}:\\d{2}$') %}
          {% set normalized_state = dict(normalized_state, **{'duration': state.duration}) %}
        {% endif %}
        {% set ns.result = ns.result + [normalized_state] %}
      {% endif %}
    
    {% endfor %}
    {{ ns.result }}
    
    
  observed_buttons: >-
    {% set ns = namespace(result=[]) %}
    {% for state in setted_states %}
      {% for button in state.buttons %}
        {% set ns.result = ns.result + [button] %}
      {% endfor %}
    {% endfor %}
    {{ ns.result }}
    
    
  observed_timers: >-
    {% set ns = namespace(result=[]) %}
    {% for state in setted_states %}
      {% if state.timer %}
        {% set ns.result = ns.result + [state.timer] %}
      {% endif %}
    {% endfor %}
    {{ ns.result }}
    
    
  debugmode: !input debugmode
  my_dbgMessage: >-
    {{ {'debug': "test0,", 'tmp_states': tmp_states, 'setted_states': setted_states, 'observed_buttons': observed_buttons, 'observed_timers': observed_timers}|to_json }}
  

trigger:
  - platform: event
    event_type: state_changed
    id: statechanged
    variables:
      triggerdevice: >-
        {%- if trigger.event.data is defined -%}
          {{
            {
              'id': trigger.event.data.entity_id,
              'new_state': trigger.event.data.new_state.state if trigger.event.data.new_state else none,
              'old_state': trigger.event.data.old_state.state if trigger.event.data.old_state else none
            }
          }}
        {%- else -%}
          {{ none }}
        {%- endif -%}
  
  
  

condition:
  - condition: and
    conditions:
      - condition: trigger
        id: statechanged
      - condition: template
        value_template: >-
          {{ trigger.event.data.entity_id is defined and trigger.event.data.entity_id != '' and 
          ( 
          trigger.event.data.entity_id.startswith('input_boolean.') or 
          trigger.event.data.entity_id.startswith('switch.') or
          trigger.event.data.entity_id.startswith('timer.')
          ) }}
      - condition: or
        conditions:
          - condition: template
            value_template: >-
              {%- if trigger.event.data.entity_id is in observed_buttons and states(trigger.event.data.entity_id) in ['on', 'off']-%}
                true
              {%- else -%}
                false
              {%- endif -%}
          - condition: template
            value_template: >-
              {%- if trigger.event.data.entity_id in observed_timers and states(trigger.event.data.entity_id) in ['idle']-%}
                true
              {%- else -%}
                false
              {%- endif -%}
  
  
  
  

action:
  - variables:
      state_data: >-
        {%- set ns = namespace(result=none) -%}
        {%- if trigger.id == 'statechanged' and triggerdevice is not none and triggerdevice is defined and triggerdevice.id is defined -%}
          {%- set triggered_entity = triggerdevice.id -%}
          {%- for state in setted_states -%}
            {%- if triggered_entity in state.buttons -%}
              {%- set ns.result = dict(state, **{'type': 'button', 'id': triggered_entity, 'state': triggerdevice.new_state}) -%}
              {%- break -%}
            {%- elif triggered_entity == state.timer -%}
              {%- set ns.result = dict(state, **{'type': 'timer', 'id': triggered_entity, 'state': triggerdevice.new_state}) -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- if ns.result is not none -%}
          {%- set ns.result = dict(ns.result , **{'old_statustext': states(statusfield)}) -%}
        {%- endif -%}
        {{- ns.result -}}
        
        
      my_dbgMessage: >-
        {% if my_dbgMessage is defined and my_dbgMessage != '' %}
          {% if my_dbgMessage is mapping %}
            {% set old_result = my_dbgMessage %}
          {% elif my_dbgMessage is string and my_dbgMessage|trim != '' %}
            {% set old_result = my_dbgMessage|from_json %}
          {% else %}
            {% set old_result = {} %}
          {% endif %}
        {% else %}
          {% set old_result = {} %}
        {% endif %}
        {% set result = dict(old_result, **{'debug': "init", 'statusfield': statusfield}) %}
        {% if state_data is defined %}
          {% set result = dict(result, **{'state_data': state_data}) %}
        {% endif %}
        {{- result|to_json }}
  - if:
      - condition: template
        value_template: "{{ state_data is not none }}"
    then:
  
      - variables:
          my_dbgMessage: >-
            {% if my_dbgMessage is defined and my_dbgMessage != '' %}
              {% if my_dbgMessage is mapping %}
                {% set old_result = my_dbgMessage %}
              {% elif my_dbgMessage is string and my_dbgMessage|trim != '' %}
                {% set old_result = my_dbgMessage|from_json %}
              {% else %}
                {% set old_result = {} %}
              {% endif %}
            {% else %}
              {% set old_result = {} %}
            {% endif %}
            {% set mydbg = (old_result.debug if old_result.debug is defined else '') ~ " test1, " %}
            {% set result = dict(old_result, **{'state_data': state_data, 'debug': mydbg}) %}
            {{- result|to_json }}
      # Timer restart      
      - if:
          - condition: and
            conditions:
              - condition: template
                value_template: "{{ state_data.type == 'button' and state_data.timer is defined and state_data.duration is defined}}"
              - condition: template
                value_template: "{{ triggerdevice is not none and triggerdevice is defined }}"
        then:
            # Timer restart      
            # Timer restart      
            - if:
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ state_data.duration is defined}}"
                    - condition: template
                      value_template: "{{ triggerdevice.new_state == 'on' }}"
              then:
                - action: notify.persistent_notification
                  metadata: {}
                  data:
                    title: "Debug TgShortTermStatusX"
                    message: "{{- 'timer restart' -}}"
                - action: timer.cancel
                  target:
                    entity_id: "{{ state_data.timer }}"
                - action: timer.start
                  target:
                    entity_id: "{{ state_data.timer }}"
                  data:
                    duration: "{{ state_data.duration }}"
            
            
            
            
            
            
            
            # Timer stop
            # Timer stop
            - if:
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ triggerdevice.new_state == 'off' }}"
              then:
                # Button wurde ausgeschaltet - Timer abbrechen falls aktiv
                - action: notify.persistent_notification
                  metadata: {}
                  data:
                    title: "Debug TgShortTermStatusX"
                    message: "{{- 'timer cancel' -}}"
            
                - if:
                    - condition: template
                      value_template: "{{ states(state_data.timer) == 'active' }}"
                  then:
                    - action: timer.cancel
                      target:
                        entity_id: "{{ state_data.timer }}"
            
            
            
            
            
      
      
      
      
      
      
      
      
      
      # Timer=idle > set all buttons off
      - if:
          - condition: template
            value_template: "{{ state_data.type == 'timer' }}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgShortTermStatusX"
              message: "{{- 'buttons off' -}}"
          - repeat:
              for_each: "{{ state_data.buttons }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ repeat.item.startswith('input_boolean.') }}"
                      sequence:
                        - action: input_boolean.turn_off
                          target:
                            entity_id: "{{ repeat.item }}"
                    - conditions:
                        - condition: template
                          value_template: "{{ repeat.item.startswith('switch.') }}"
                      sequence:
                        - action: switch.turn_off
                          target:
                            entity_id: "{{ repeat.item }}"   
      
      
      
      
      
      
      
      # Button-Änderung - synchronisiere alle anderen Buttons dieses Status
      - if:
          - condition: template
            value_template: "{{ state_data.type == 'button' and state_data.id is defined }}"
        then:
          # Button-Änderung - synchronisiere alle anderen Buttons dieses Status
          - variables:
              target_state: "{{ triggerdevice.new_state if triggerdevice is not none and triggerdevice is defined and triggerdevice.new_state is defined else '' }}"
          - if:
              - condition: template
                value_template: "{{ target_state != '' }}"
              - condition: template
                value_template: "{{ (state_data.buttons | reject('eq', state_data.id) | list) | length > 0 }}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgShortTermStatusX"
                  message: "{{- 'buttons sync' ~ ' ' ~ target_state  -}}"
              - repeat:
                  for_each: "{{ state_data.buttons | reject('eq', state_data.id) | list }}"
                  sequence:
                    - action: notify.persistent_notification
                      metadata: {}
                      data:
                        title: "Debug TgShortTermStatusX"
                        message: "{{- 'buttons sync' ~ ' ' ~ target_state ~ ' ' ~ repeat.item ~ ' ' ~ states(repeat.item) -}}"
      
                    - if:
                        - condition: and
                          conditions:
                            - condition: template
                              value_template: "{{ states(repeat.item) != target_state }}"
                      then:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ repeat.item.startswith('input_boolean.') }}"
                              sequence:
                                - if:
                                  - condition: template
                                    value_template: "{{ target_state == 'on' }}"
                                  then:
                                    - action: input_boolean.turn_on
                                      target:
                                        entity_id: "{{ repeat.item }}"
                                  else:
                                    - action: input_boolean.turn_off
                                      target:
                                        entity_id: "{{ repeat.item }}"
                            - conditions:
                                - condition: template
                                  value_template: "{{ repeat.item.startswith('switch.') }}"
                              sequence:
                                - if:
                                  - condition: template
                                    value_template: "{{ target_state == 'on' }}"
                                  then:
                                    - action: switch.turn_on
                                      target:
                                        entity_id: "{{ repeat.item }}"
                                  else:
                                    - action: switch.turn_off
                                      target:
                                        entity_id: "{{ repeat.item }}"
      
      
      
      
  # Bestimme Statustext durch Prüfung aller Status
  - variables:
      statustext: >-
        {%- set ns = namespace(result='') -%}
        {%- for state in setted_states -%}
          {%- if state.buttons is defined and state.buttons | length > 0 -%}
            {%- if states(state.buttons[0]) == 'on' -%}
              {%- if state.statustext is defined and state.statustext != '' and state.statustext != '-' -%}
                {%- set ns.result = state.statustext -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {{- ns.result -}}
  # Setze Statustext falls geändert
  - if:
      - condition: template
        value_template: "{{- statusfield and statusfield != '-' and statusfield != '' and statusfield.startswith('input_text.') and states(statusfield) != 'unavailable' -}}"
      - condition: template
        value_template: "{{- statustext != states(statusfield) -}}"
    then:
      - action: input_text.set_value
        target:
          entity_id: "{{- statusfield -}}"
        data:
          value: "{{- statustext -}}"
  
  
  
  # Debug - Message  Devices    
  - if:
      - condition: template
        value_template: "{{ debugmode and my_dbgMessage is defined and my_dbgMessage != '' }}"
    then:
      - action: notify.persistent_notification
        metadata: {}
        data:
          title: "Debug TgShortTermStatus"
          message: >-
            {# ___________________________________________________ #}
            {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
              {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
              {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
            
              {%- set dump = namespace() -%} 
              {%- set dump.tmp="" -%}
              {%- set dump.val=val -%}
              {%- set dump.valType=none -%}
              {%- set myFilter=filter -%}
              {%- set filter=[] -%}
              {%- set thisStep=thisStep + 1 -%}
              
              {%- if thisStep > maxSteps -%}
                {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                {%- set dump.valType="json" -%}
              {%- else -%}
                {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                  {%- set dump.val=dump.val|replace("'", '"')|from_json -%}
                {%- endif -%}
                {%- if dump.val is list -%}
                  {%- set dump.valType="list" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                  {%- for item in dump.val -%}
                    {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                    {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                {%- elif dump.val is mapping -%}
                  {%- set dump.valType="dict" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                  {%- for name, item in dump.val.items() -%}
                    {%- if thisStep > 1 or name not in myFilter -%}
                      {%- set preTxt = "<li>" -%}
                      {%- set postTxt = "</li>" -%}
                      {%- set nameTxtStart = "<b>" -%}
                      {%- set NameTxtEnd = "</b>" -%}
                      {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                      {%- if details == thisStep and myDump[0] == "dict" -%}
                        {%- set preTxt = preTxt ~ "<details>" -%}
                        {%- set postTxt = "</details>" ~ postTxt -%}
                        {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                        {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                      {%- endif -%}
            
                      {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                {%- elif dump.val is string or dump.val is number -%}
                  {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%} 
                  {%- set dump.valType="string" -%}
                {%- endif -%}
              {%- endif -%}
            
              {%- if thisStep == 1 -%}
                {{- dump.tmp -}}
              {%- else -%}
                {{- [dump.valType, dump.tmp]|to_json -}}
              {%- endif -%}
            {%- endmacro -%}
            {{ "Debug Message:" ~ dumpToHTML(my_dbgMessage, [], 5, true, 2) }}
            {{ dumpToHTML(triggerdevice, [], 5, true, 2) }}
  
  

mode: queued
