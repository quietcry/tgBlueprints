


blueprint:
  name: tgHeating
  domain: automation
  description: Heating Control based on state of persons in combination with switches
  source_url: https://github.com/quietcry/tgHeating/blob/09539fd1af9e55f1c1d29c87956c7e94d8b8f5ca/tgHeating.yaml
  homeassistant:
    min_version: 2023.12.0
  input:
    debugmode:
      name: "debug mode"
      description: Configuration
      default: false
      selector:
        boolean:
  
    conf_persons:
      name: person state entities
      icon: mdi:cog
      collapsed: true
      description: Configuration 
      input:  
        linked_persons:
          name: persons or text-helpers with state of persons
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain:
                  - person
                  - input_text
    conf_devices:
      name: heating devices
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        linked_heatings:
          name: heating devices
          description: Select all heating devices that you want to control. The friendly_name attribute should start with the unique abbreviation that you use in your configuration.
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: climate
  
    conf_temperatures:
      name: General Temperatures
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        eco_temperature:
          name:  "Temperature Eco-Mode"
          description: Configuration
          default: '19'
          selector:
            number:
              min: 5
              max: 28
              step: 0.5
              mode: slider
              unit_of_measurement: °C
        eco_device:
          name:  "Helper for dynamic changing"
          description: Configuration
          default:
          selector:
            entity:
              filter:
              - domain:
                - input_number
              multiple: false
        comfort_temperature:
          name:  "Temperature Comfort-Mode"
          description: Configuration
          default: '21'
          selector:
            number:
              min: 5
              max: 28
              step: 0.5
              mode: slider
              unit_of_measurement: °C
        comfort_device:
          name:  "Helper for dynamic changing"
          description: Configuration
          default:
          selector:
            entity:
              filter:
              - domain:
                - input_number
              multiple: false
        away_temperature:
          name:  "Temperature away-Mode"
          description: Configuration
          default: '15'
          selector:
            number:
              min: 5
              max: 28
              step: 0.5
              mode: slider
              unit_of_measurement: °C
        away_device:
          name:  "Helper for dynamic changing"
          description: Configuration
          default:
          selector:
            entity:
              filter:
              - domain:
                - input_number
              multiple: false
    advanced_config_section:
      name: optional Advanced Configuration for Devices
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        inp_advanced_dev_config:
          name:  "Advanced Configuration:"
          description: "json-string or yaml-configuration\n it describes more special properties of your devices\n<details>
              <summary><code><strong>CLICK HERE FOR HELP:</strong></code></summary> 
              <br/> <b>json</b>:<br>\n\n```json\n{
              \n\"<DEVICE IDENTIFIER>\":\n\t{\n\t\"<PROPERTY_1_NAME>\": \"<PROPERTY_1_VALUE>\"\n\t\"<PROPERTY_2_NAME>\": \"<PROPERTY_2_VALUE>\"\n\t}\n}\n```\n
              <br/> <b>yaml</b>:<br>\n\n```yaml\n
              <DEVICE IDENTIFIER>:\n\t<PROPERTY_1_NAME>: <PROPERTY_1_VALUE>\n\t<PROPERTY_2_NAME>: <PROPERTY_2_VALUE>\n```\n
              DEVICE IDENTIFIER = the shortcut of your device\n
              PROPERTIES:\n eco = your temperatur in eco mode\n comfort = your temperatur in comfort mode\n away = your temperatur in away mode\n
               faders = [subkeys=eco,away,comfort,target]\n for any mode you can set a number helper for control\nadditional it is possible to set an helper for overdriving the target-temperature here 
              \n</details>\n"
          default: '{}'
          selector:
            object:
  
    conf_basic:
      name: Base Configuration
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        default_cmd:
          name:  "default:"
          default: '{}'
          selector:
            object:
  
        sequence:
          name: "sequence"
          default: 'off,boost,T,WP,P'
  
    conf_statusfile:
      name: store in statefile
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        inp_use_statehelper:
          name:  "state file helper:"
          default: '-'
          selector:
            entity:
              filter:
              - domain:
                - input_text
              multiple: false
        inp_use_statefile:
          name:  "state file path:"
          default: '-'
          selector:
            text:
              multiline: false
  
    conf_weekplan:
      name: Weekplan Configuration
      icon: mdi:cog
      collapsed: true
      description: Configuration
      input:  
        weekplan_cmd:
          name:  "Weekplans:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        weekplan_timer:
          name: "Weekplan-Timer"
          default: '-'
          selector:
            entity:
              multiple: false
              filter:
                domain:
                  - timer
  
  
    cmd:
      name: 'JSON Command line'
      default: '{}'
      selector:
        object:
        # text:
        #   multiline: true
  
    switch_1:
      name: switch 1
      icon: mdi:cog
      collapsed: true
      description: configuration switch 1
      input:  
        switch_1_device:
          name: switch entity
          default: "-"
          selector:
            entity:
              multiple: false          
              filter:
                domain: 
                  - input_boolean
                  - input_schedule
        switch_1_on_cmd:
          name:  "on-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        switch_1_on_mode:
          name: "exclusive Mode (on)"
          default: 
          selector:
            boolean:
  
        switch_1_off_cmd:
          name:  "off-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
        switch_1_off_mode:
          name: "exclusive Mode (off)"
          default: 
          selector:
            boolean:
  
    switch_2:
      name: switch 2
      icon: mdi:cog
      collapsed: true
      description: configuration switch 2
      input:  
        switch_2_device:
          name: switch entity
          default: "-"
          selector:
            entity:
              multiple: false          
              filter:
                domain: 
                  - input_boolean
                  - input_schedule
        switch_2_on_cmd:
          name:  "on-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        switch_2_on_mode:
          name: "exclusive Mode (on)"
          default: 
          selector:
            boolean:
  
        switch_2_off_cmd:
          name:  "off-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
        switch_2_off_mode:
          name: "exclusive Mode (off)"
          default: 
          selector:
            boolean:
  
    switch_3:
      name: switch 3
      icon: mdi:cog
      collapsed: true
      description: configuration switch 3
      input:  
        switch_3_device:
          name: switch entity
          default: "-"
          selector:
            entity:
              multiple: false          
              filter:
                domain: 
                  - input_boolean
                  - input_schedule
        switch_3_on_cmd:
          name:  "on-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        switch_3_on_mode:
          name: "exclusive Mode (on)"
          default: 
          selector:
            boolean:
  
        switch_3_off_cmd:
          name:  "off-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
        switch_3_off_mode:
          name: "exclusive Mode (off)"
          default: 
          selector:
            boolean:
  
    switch_4:
      name: switch 4
      icon: mdi:cog
      collapsed: true
      description: configuration switch 4
      input:  
        switch_4_device:
          name: switch entity
          default: "-"
          selector:
            entity:
              multiple: false          
              filter:
                domain: 
                  - input_boolean
                  - input_schedule
        switch_4_on_cmd:
          name:  "on-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        switch_4_on_mode:
          name: "exclusive Mode (on)"
          default: 
          selector:
            boolean:
  
        switch_4_off_cmd:
          name:  "off-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
        switch_4_off_mode:
          name: "exclusive Mode (off)"
          default: 
          selector:
            boolean:
  
    switch_5:
      name: switch 5
      icon: mdi:cog
      collapsed: true
      description: configuration switch 5
      input:  
        switch_5_device:
          name: switch entity
          default: "-"
          selector:
            entity:
              multiple: false          
              filter:
                domain: 
                  - input_boolean
                  - input_schedule
        switch_5_on_cmd:
          name:  "on-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
  
        switch_5_on_mode:
          name: "exclusive Mode (on)"
          default: 
          selector:
            boolean:
  
        switch_5_off_cmd:
          name:  "off-cmd:"
          default: '{}'
          selector:
            object:
            # text:
            #   multiline: true
        switch_5_off_mode:
          name: "exclusive Mode (off)"
          default: 
          selector:
            boolean:

variables:
  cmdStrTstPatternDict: '^[\s]*\{[\s\S]*\}[\s]*$'
  cmdStrTstPatternList: '^[\s]*\[[\s\S]*\][\s]*$'
  cmdStrTstPatternNumPK: '^\d*[.,]{0,1}\d*$'
  cmdStrTstPatternNumP:  '^\d*\.{0,1}\d*$'
  
  const_common_config:    {
                          "climate" :     {
                                          "eco": 19,
                                          "comfort": 21,
                                          "away": 12,
                                          "boostduration": 5,
                                          "waitnextboost": 30,
                                          "overdriveduration": 120,
                                          "latestclear": "00:00"
                                          }
                          }              
  
  linked_persons: !input linked_persons
  linked_heatings: !input linked_heatings
  inp_use_statefile: !input inp_use_statefile
  inp_use_statehelper: !input inp_use_statehelper
  
  weekplan_timer: !input weekplan_timer
  weekplan_cmd: !input weekplan_cmd
  weekplan_delay_seconds: 5
  
  var_temp_classes: {
                'eco':  {
                        'temp': !input eco_temperature,
                        'device': !input eco_device
                        },
                'comfort':  {
                        'temp': !input comfort_temperature,
                        'device': !input comfort_device
                        },
                'away':  {
                        'temp': !input away_temperature,
                        'device': !input away_device
                        }
                }
  
  var_advanced_dev_config: !input inp_advanced_dev_config
  
  
  cmd: !input cmd
  sequence: !input sequence
  default_cmd: !input default_cmd
  debugmode: !input debugmode
  coolingmode: true
  switches:   [
              {
              'name': "switch_1",  
              'device': !input switch_1_device,
              'on_cmd': !input switch_1_on_cmd,
              'on_mode': !input switch_1_on_mode,
              'off_cmd': !input switch_1_off_cmd,
              'off_mode': !input switch_1_off_mode,
              },
              {
              'name': "switch_2",  
              'device': !input switch_2_device,
              'on_cmd': !input switch_2_on_cmd,
              'on_mode': !input switch_2_on_mode,
              'off_cmd': !input switch_2_off_cmd,
              'off_mode': !input switch_2_off_mode,
              },
              {
              'name': "switch_3",  
              'device': !input switch_3_device,
              'on_cmd': !input switch_3_on_cmd,
              'on_mode': !input switch_3_on_mode,
              'off_cmd': !input switch_3_off_cmd,
              'off_mode': !input switch_3_off_mode,
              },
              {
              'name': "switch_4",  
              'device': !input switch_4_device,
              'on_cmd': !input switch_4_on_cmd,
              'on_mode': !input switch_4_on_mode,
              'off_cmd': !input switch_4_off_cmd,
              'off_mode': !input switch_4_off_mode,
              },
              {
              'name': "switch_5",  
              'device': !input switch_5_device,
              'on_cmd': !input switch_5_on_cmd,
              'on_mode': !input switch_5_on_mode,
              'off_cmd': !input switch_5_off_cmd,
              'off_mode': !input switch_5_off_mode,
              },
              ]
  
  observed: >-
    {#----------------------------------------------------------------------------#}
    {%- macro observer(key, itemlist) -%}
      {%- set ns.myEntitiesTmp = {} -%}
      {%- set ns.preparedItemlist = [] -%}
      {%- if ns.myEntities is mapping -%}
        {%- for classkey, item in ns.myEntities.items() -%}
          {%- if classkey != key -%}    
            {%- set items = {classkey:item} -%}
            {%- set ns.myEntitiesTmp = dict(ns.myEntitiesTmp, **items) -%}
          {% else %}
            {%- if item is list -%}
              {%- set ns.preparedItemlist = item -%}
            {%- elif item is string -%}
              {%- set ns.preparedItemlist = [item] -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      
      {%- if itemlist is none -%}
        {# itemlist ist None, nichts zu tun #}
      {%- elif itemlist is string and itemlist != "-" and itemlist|length > 0 -%}
        {%- set ns.preparedItemlist = ns.preparedItemlist + [itemlist] -%}
      
      {%- elif itemlist is mapping -%}
        {%- for item, val in itemlist.items() -%}
          {%- if val is mapping and "device" in val  -%}
            {%- set ns.preparedItemlist = ns.preparedItemlist + [val.device] -%}
          {%- endif -%}
        {%- endfor -%}
        
      {%- elif itemlist is list -%}
        {%- for item in itemlist -%}
          {%- if item is string and item != "-" and item|length > 0 -%}
            {%- set ns.preparedItemlist = ns.preparedItemlist + [item] -%}
          {%- endif -%}
        {%- endfor -%}
    
      {%- endif -%}
      
      {%- set ns.testedItemlist = [] -%}
      {%- for item in ns.preparedItemlist -%}
        {%- if states(item) != 'unknown' and not item in ns.testedItemlist -%}
          {%- set ns.testedItemlist = ns.testedItemlist + [item] -%}
        {%- endif -%}
      {%- endfor -%}
      {%- set items = {key:ns.testedItemlist} -%}
      {%- set ns.myEntitiesTmp = dict(ns.myEntitiesTmp, **items) -%}
      {%- set ns.myEntities = ns.myEntitiesTmp -%}
    
    {%- endmacro -%}
    {#----------------------------------------------------------------------------#}
    
    {%- set ns = namespace()%}
    {%- set ns.myEntities = {} -%}
    
    {%- set status = observer("persons", linked_persons)  -%}
    
    {%- for switch in switches -%}
      {%- if switch.device is defined -%}
        {%- set status = observer("switches", switch.device)  -%}
      {%- endif -%}
    {%- endfor -%}
        {%- set status = observer("fader", var_temp_classes.values() | map(attribute="device")|list ) -%}
        {%- set tmp_advanced_dev_config = var_advanced_dev_config -%}
        {%- if tmp_advanced_dev_config is string -%}
          {%- if tmp_advanced_dev_config is search(cmdStrTstPatternDict) -%}
            {%- set tmp_advanced_dev_config = tmp_advanced_dev_config|replace("'", '"')|from_json -%}
          {%- else -%}
            {%- set tmp_advanced_dev_config = {} -%}
          {%- endif -%}
        {%- elif not (tmp_advanced_dev_config is mapping) -%}
          {%- set tmp_advanced_dev_config = {} -%}
        {%- endif -%}
        {%- if tmp_advanced_dev_config is mapping -%}
          {%- for key, val in tmp_advanced_dev_config.items() -%}
            {%- if val is mapping and val.faders is defined -%}
              {%- if val.faders is mapping -%}
                {%- for fader, faderval in val.faders.items() -%}
                  {%- if fader == "target" or fader == "overdrive" -%}
                    {%- set status = observer("overdrive",faderval)  -%}
                  {%- else -%}
                    {%- set status = observer("fader",faderval)  -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
    
    
    {{- ns.myEntities -}}

trigger:
  - platform: event
    event_type: state_changed
    id: statechanged
    variables:
      triggerdevice: "{{ {'id':trigger.event.data.entity_id} }}"
  #    triggerdevice: "{{ {'id':trigger.event.data.entity_id, 'old_state':trigger.event.data.old_state, 'new_state':trigger.event.data.new_state} }}"
  
  - platform: homeassistant
    event: start
    id: haStart
  # only for development    
  - platform: state
    entity_id: input_boolean.reloadconfig
    from: "on"
    to: "off"
    id: "reloadConfig"

condition:
  
  - condition: or
    conditions:
      - condition: trigger
        id:
          - haStart
          - reloadConfig
      - condition: template
        value_template: >-
          {%- if observed is list -%}
            {%- if trigger.event.data.entity_id in observed -%}
              true
            {%- endif -%}
          {%- elif observed is mapping -%}
            {%- for key, entities in observed.items() -%}
              {%- if trigger.event.data.entity_id in entities -%}
                true
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
  
          
      - condition: template
        value_template: " {%- if trigger.event.data.entity_id == weekplan_timer and states(weekplan_timer) != 'active' -%}true{%- endif -%}"
      - condition: template
        value_template: >-
          {%- if cmd is search("^input_text\.[a-z0-9_-]+$") -%}
            {%- if trigger.event.data.entity_id in states | selectattr("entity_id", "equalto", cmd ) | map(attribute='entity_id') | list -%}
              {{- true -}}
            {%- else -%}
              {%- set mylist = [] -%}
              {%- set config = states(cmd) -%}{%- if config is defined and config is search(cmdStrTstPatternDict) -%}{%- set config = config|from_json -%}{%- else -%}{%- set config = {} -%}{%- endif -%}
              {%- if "persons" in config and config["persons"] is list -%} {%- set mylist = mylist + config["persons"] -%} {%- endif -%}
              {%- if "switches" in config and config["switches"] is list -%} {%- set mylist = mylist + config["switches"] | map(attribute='device' , default="undefind") | list -%} {%- endif -%}
              {%- if trigger.event.data.entity_id in mylist -%}
                {{- true -}}
              {%- else -%}
                {{- false -}}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}

action:
  - variables:
      statefile_read_state: false
      statefile_write_state: false
      statefile_test_state: false
      statefile_test_text: >-
        {{- now()|as_timestamp|string -}}
  
  - if:
      - condition: template
        value_template: >-
            {%- if inp_use_statefile is string and inp_use_statefile|length > 0 and inp_use_statefile != "-"-%}
              {{- true -}}
            {%- endif -%}
    then:
      - action: shell_command.read_from_file
        data:
          file: "{{- inp_use_statefile -}}"
        response_variable: statefile_read_state
  
  - if:
      - condition: template
        value_template: >-
            {%- if statefile_read_state and ( statefile_read_state.returncode != 0  or statefile_read_state.stdout == "ERROR" ) -%}
              {{- true -}}
            {%- elif statefile_read_state and not statefile_read_state.stdout is search(cmdStrTstPatternDict) -%}
              {{- true -}}
            {%- endif -%}
    then:
      - action: shell_command.write_to_file
        data:
          file: "{{- inp_use_statefile -}}"
          txt: "{{-statefile_test_text-}}"
        response_variable: statefile_write_state
  
  - if:
      - condition: template
        value_template: >-
            {%- if statefile_write_state -%}
              {{- true -}}
            {%- endif -%}
    then:
      - action: shell_command.read_from_file
        data:
          file: "{{- inp_use_statefile -}}"
        response_variable: statefile_test_state
  

  - variables:
      statefile_state: >- 
        {%- set ns = namespace() -%}
        {# {%- set ns.state = {"state":false, "txt": statefile_test_text, "r":statefile_read_state, "w": statefile_write_state, "t": statefile_test_state} -%} #}
        {%- set ns.state = {"state":false, "input": "", "output": "" } -%}
        
        
        {%- if statefile_read_state is mapping and statefile_read_state.returncode == 0 and statefile_read_state.stdout != "ERROR"-%}
            {%- if statefile_write_state is boolean and statefile_read_state.stdout is search(cmdStrTstPatternDict) -%}
                {%- set ns.state = dict(ns.state, **{"state":"file", "input": statefile_read_state.stdout|replace("'", '"') }) -%}
            {%- elif statefile_test_state is mapping and statefile_test_state.stdout|float|string == statefile_test_text|float|string -%}
                {%- set ns.state = dict(ns.state, **{"state":"file", "input": "" }) -%}
            {%- endif -%}
        {%- endif -%}
        
        {%- if  ns.state.state == false and inp_use_statehelper is string and inp_use_statehelper|length > 0 and inp_use_statehelper != "-" and states(inp_use_statehelper) != "unavailable"-%}
            {%- set ns.tmp = states(inp_use_statehelper) -%}
            {%- if ns.tmp is search('^"') -%}{%- set ns.tmp = ns.tmp[1:] -%}{%- endif -%}
            {%- if ns.tmp is search('"$') -%}{%- set ns.tmp = ns.tmp[:1] -%}{%- endif -%}
            {%- if ns.tmp is search(cmdStrTstPatternDict) -%}
                {%- set ns.state = dict(ns.state, **{"state":"helper", "input": ns.tmp}) -%}
            {%- else -%}
                {%- set ns.state = dict(ns.state, **{"state":"helper", "input": "" }) -%}
            {%- endif -%}
        
        {%- endif -%} 
        {{ ns.state }}

      myConfig: >-
        {# ___________________________________________________ #}
        {%- macro convert2Object(obj={}) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.obj = obj -%}
          {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
          {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
          {%- if nsm.obj is string  -%}
            {%- if nsm.obj is search(patternList) or nsm.obj is search(patternMap) -%}
                {%- set nsm.obj = nsm.obj|replace("'", '"') -%}
            {%- else -%}
                {%- set nsm.obj = [nsm.obj] |to_json-%}
            {%- endif -%}
          {%- elif nsm.obj is number  -%}
            {%- set nsm.obj = [nsm.obj] |to_json -%}
          {%- elif nsm.obj is mapping or nsm.obj is list   -%}
            {%- set nsm.obj = nsm.obj |to_json -%}
          {%- endif -%}
          {{- nsm.obj -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {%- macro readconfig() -%}
          {%- set cfg = namespace() -%}
          {%- set nsm = namespace() -%}
          {%- set cfg.observed = observed -%}
          {%- set cfg.advancedDevConfig = var_advanced_dev_config -%}
          {%- if weekplan_timer and states(weekplan_timer) != 'unknown' -%}
            {%- set cfg.observed = dict(cfg.observed, **{"timer": [weekplan_timer] }) -%}
          {%- endif -%}
          {%- set cfg.sequence = sequence -%}
          {%- set cfg.defaultCmd = convert2Object(default_cmd)|from_json -%}
        
          {%- set nsm.switches = {} -%}
          {%- set cfg.weekplans = { "timer":weekplan_timer,
                                    "plans":convert2Object(weekplan_cmd)|from_json
                                  } -%}
        
          {%- set cfg.statefilestate = statefile_state -%}
          {%- set cfg.cmd = convert2Object(cmd)|from_json -%}
          {%- set cfg.debug = "" -%}
          {%- set myswitches = switches -%}
        
          {%- set keys = myswitches| map(attribute='name' , default="undefind") | list | sort %}
          {%- set nsm.pos = 0 %}
          {%- for key in keys -%}
            {%- for switch in myswitches -%}
              {%- if "name" in switch and switch["name"] == key and "device" in switch and states(switch["device"]|string) != "unknown"-%}
                {%- set nsm.pos = nsm.pos + 1 %}
                {%- set switch = dict(switch, **{"position":nsm.pos})  -%}
                {%- set nsm.switches = dict(nsm.switches, **{switch.device:switch})  -%}
              {%- endif -%} 
            {%- endfor -%}
          {%- endfor -%}
        
          {%- set cfg.devices = observed  -%}
          {%- set cfg.devices = dict(cfg.devices, **{"switches":nsm.switches})  -%}
          {%- set cfg.devices = dict(cfg.devices, **{"climate":linked_heatings})  -%}
        
          {# -------------  die Geräteklasse des auslösenden Geräts wird bestimmt -------------- #}
          {%- set cfg.triggerDevice=none -%}
          {%- set cfg.triggerClass=none -%}
          {%- if triggerdevice is defined and triggerdevice is mapping and cfg.observed is mapping-%}
            {%- set cfg.triggerDevice=triggerdevice.id -%}
            {%- for key, entities in cfg.observed.items() -%}
              {%- if entities is list and triggerdevice.id in entities -%}
                {%- set cfg.triggerClass=key -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {# -------------  die Konfiguration wird zusammengesetzt -------------- #}
          {%- set cfg.config = const_common_config -%}
          {%- set cfg.climate = {} if not "climate" in cfg.config else cfg.config.climate -%}
          {%- for key, val in var_temp_classes.items() -%}   
            {%- if val.device is string and val.device|length > 0 and "fader" in cfg.observed and val.device in cfg.observed.fader -%}
              {%- set cfg.climate = dict(cfg.climate, **{key:states(val.device)}) -%}
            {%- else -%}
              {%- set cfg.climate = dict(cfg.climate, **{key:val.temp|string|float}) -%}
            {%- endif -%}
        
          {%- endfor -%}
          {%- set cfg.config = dict(cfg.config, **{"climate":cfg.climate}) -%}
        
          {%- set nsm.result = {
            "config"              : cfg.config,
            "observed"            : cfg.observed,
            "advancedDeviceConfig": cfg.advancedDevConfig,
            "devices"             : cfg.devices,
            "sequence"            : cfg.sequence,
            "cmd"                 : cfg.cmd,
            "weekplans"           : cfg.weekplans,
            "statefilestate"      : cfg.statefilestate,
            "defaultCmd"          : cfg.defaultCmd,
            "triggerDevice"       : cfg.triggerDevice,
            "triggerClass"        : cfg.triggerClass
            } -%}
        
          {{- nsm.result -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {%- set result=readconfig() -%}
        {{- result -}}

  - if:
      - condition: template
        value_template: "{{debugmode}}"
    then:
      - variables:
          debugMsg: >-
            {# ___________________________________________________ #}
            {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
              {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
              {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
            
              {%- set dump = namespace() -%} 
              {%- set dump.tmp="" -%}
              {%- set dump.val=val -%}
              {%- set dump.valType=none -%}
              {%- set myFilter=filter -%}
              {%- set filter=[] -%}
              {%- set thisStep=thisStep + 1 -%}
              
              {%- if thisStep > maxSteps -%}
                {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                {%- set dump.valType="json" -%}
              {%- else -%}
                {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                  {%- set dump.val=dump.val|replace("'", '"')|from_json -%}
                {%- endif -%}
                {%- if dump.val is list -%}
                  {%- set dump.valType="list" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                  {%- for item in dump.val -%}
                    {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                    {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                {%- elif dump.val is mapping -%}
                  {%- set dump.valType="dict" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                  {%- for name, item in dump.val.items() -%}
                    {%- if thisStep > 1 or name not in myFilter -%}
                      {%- set preTxt = "<li>" -%}
                      {%- set postTxt = "</li>" -%}
                      {%- set nameTxtStart = "<b>" -%}
                      {%- set NameTxtEnd = "</b>" -%}
                      {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                      {%- if details == thisStep and myDump[0] == "dict" -%}
                        {%- set preTxt = preTxt ~ "<details>" -%}
                        {%- set postTxt = "</details>" ~ postTxt -%}
                        {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                        {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                      {%- endif -%}
            
                      {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                {%- elif dump.val is string or dump.val is number -%}
                  {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%} 
                  {%- set dump.valType="string" -%}
                {%- endif -%}
              {%- endif -%}
            
              {%- if thisStep == 1 -%}
                {{- dump.tmp -}}
              {%- else -%}
                {{- [dump.valType, dump.tmp]|to_json -}}
              {%- endif -%}
            {%- endmacro -%}
            
            {# {{ myConfig }} #}
            {{ "Konfigurations:" ~ dumpToHTML(myConfig, ["persons"], 5, true, 3) }}

      - action: notify.persistent_notification
        metadata: {}
        data:
          title: "Debug TgHeating"
          message: >-
            {{debugMsg}}
            triggered by: <ul><li>{%- if "id" in trigger -%}{{- trigger["id"] }}{%- endif %} [<i>{%- if "entity_id" in trigger -%}{{- trigger["entity_id"] }}{%- else -%}{{- trigger -}}{%- endif -%}</i>]</li></ul>
  - variables:
      myWeekplan: >-
        {# ___________________________________________________ #}
        {%- macro convert2Object(obj={}) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.obj = obj -%}
          {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
          {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
          {%- if nsm.obj is string  -%}
            {%- if nsm.obj is search(patternList) or nsm.obj is search(patternMap) -%}
                {%- set nsm.obj = nsm.obj|replace("'", '"') -%}
            {%- else -%}
                {%- set nsm.obj = [nsm.obj] |to_json-%}
            {%- endif -%}
          {%- elif nsm.obj is number  -%}
            {%- set nsm.obj = [nsm.obj] |to_json -%}
          {%- elif nsm.obj is mapping or nsm.obj is list   -%}
            {%- set nsm.obj = nsm.obj |to_json -%}
          {%- endif -%}
          {{- nsm.obj -}}
        {%- endmacro -%}
        {#- ___________________________________________________ -#}
        {%- macro getSeconds(days, strg, mode="next") -%} 
          {%- set ns1 = namespace() -%}   
          {%- set ns1.strg = strg|string -%}
          {%- for counter in range(0 , 4 ) -%}
            {%- if ns1.strg|length < 4  -%}
              {%- set ns1.strg = "0" ~ ns1.strg -%}
            {%- else -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns1.dann = ns.midnight + timedelta(hours=(ns1.strg[:2]|int), minutes=(ns1.strg[2:]|int )) -%}
          {%- if mode == "next" -%}
            {%- set ns1.dann = ns1.dann + timedelta(days=(days|int)) -%}
            {%- set ns1.dann = (as_timestamp(ns1.dann) - as_timestamp(ns.jetzt))|int -%}
          {%- else -%}
            {%- set ns1.dann = ns1.dann - timedelta(days=(days|int)) -%}
            {%- set ns1.dann = (as_timestamp(ns.jetzt) - as_timestamp(ns1.dann))|int -%}
          {%- endif -%}
          {{ns1.dann}}
        {%- endmacro -%}
        {#- ___________________________________________________ -#}
        
        {#- ___________________________________________________ -#}
        {%- macro getDayPlan(dayoffset, wplanAsName, planDay, mode, counter=0) -%}
          {%- set gdp = namespace() -%}
          {%- set wplan = (ns.weekplans[wplanAsName] or {} ) -%}
          {%- set gdp.result = none -%}
          {%- set gdp.counter = counter -%}
          {%- set gdp.planDay = planDay -%}
          {%- if gdp.planDay < 1 -%}{%- set gdp.planDay = gdp.planDay +7 -%}{%- endif -%}         
          {%- if gdp.planDay|string in wplan -%}
        
            {%- set dplan = wplan[gdp.planDay|string] -%}
            {#           
            {%- set ns.debug = ns.debug ~ "|#| = " ~ (gdp.planDay) ~ "-" ~ gdp.counter ~ "-" ~ dayoffset ~ " >> " ~ dplan ~"<br>"-%}
            #}
            {%- set gdp.counter = gdp.counter + 1 -%}
            {%- if gdp.counter > 7 -%}
              {%- set gdp.result = none -%}
            {%- elif dplan is list -%}
              {%- set gdp.result = dplan -%}
            {%- elif dplan is string and dplan is match("^\*$")-%}
              {%- set gdp.result = getDayPlan(dayoffset, wplanAsName, (gdp.planDay-1), mode, gdp.counter)|from_json -%}
            {%- elif dplan is string and dplan is match("^\d$") and dplan|int >= 1 and dplan|int <= 7 -%}
              {%- set gdp.result = getDayPlan(dayoffset, wplanAsName, (dplan|int), mode, gdp.counter)|from_json -%}
            {%- elif dplan is string and dplan is match("^\d:.+$" ) and dplan[:1]|int >= 1 and dplan[:1]|int <= 7 -%}
              {%- if dplan[2:] is in ns.weekplans-%}
                {%- set gdp.result = getDayPlan(dayoffset, dplan[2:], (dplan[:1]|int), mode, gdp.counter)|from_json -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
          {%- if gdp.result != none and gdp.counter == 1 -%}
           
            {%- if gdp.result is list -%}
              {%- set gdp.plan = [] -%}            
              {% for item in gdp.result %}           
                {%- if item is string and item is match("^\d{1,2}:\d{1,2}-.*$")-%}
                  {%- set itemx = item.split("-") -%} {%- set item1 = itemx[0].split(":") -%} {%- set item1 = (item1[0] ~ item1[1])|int -%}                     
                  {%- set gdp.plan = 
                    gdp.plan + 
                      [
                        {
                        "time":item1,
                        "action": item[(itemx[0]|length + 1):], 
                        "timestring": itemx[0],
                        "secondsFromNow": getSeconds(dayoffset, item1, mode),
                        "day": gdp.planDay,
                        "dayoffset": dayoffset
                        }
                      ] -%}
                {%- endif -%}
              {%- endfor -%}
              {%-set gdp.result = gdp.plan -%}
            {%- else -%}
              {%- set gdp.result = none -%} 
            {%- endif -%}
          {%- endif -%}
          {%- if gdp.result is list and gdp.result|length == 0 -%}{%-set gdp.result = None -%}{%- endif -%}
          {{- gdp.result|to_json -}}
        {%- endmacro -%}
        {#- ___________________________________________________ -#}
        
        {#- ___________________________________________________ -#}
        {%- macro getPlanItem(plan, cT, mode) -%}
          {%- set result = none -%}
          {%- set gca = namespace() -%}
          {%- set gca.planTimes = [] -%}
          {%- set gca.currentItem = none -%}
          {%- if plan is list -%}
            {%- set plan = plan | sort(attribute="time") -%}
            {% for item in plan %}
              {%- if mode == "last" and item.time <= cT and ( gca.currentItem == none or item.time > gca.currentItem.time ) -%}
                {%- set gca.currentItem = item -%}
              {%- elif mode == "next" and item.time > cT and ( gca.currentItem == none or item.time < gca.currentItem.time ) -%}
                {%- set gca.currentItem = item -%}
              {%- endif -%}
            {%- endfor -%}
           {%- set result = gca.currentItem  -%}
          {%- endif -%}
          {{- result|to_json -}}         
        {%- endmacro -%}
        {#- ___________________________________________________ -#}
        
        {#- ___________________________________________________ -#}
        {%- macro getcurrentItemFromPlan(planName, startday, mode="next") -%}
          {%- set gci = namespace() -%}
          {%- set gci.day = startday -%}
          {%- set gci.result = none -%}
        
          {% for dayoffset in range(0 , 7 ) %}
            {%- if mode == "last" -%}
              {%- set gci.compareTime = 2400 -%}
              {%- set gci.day = gci.day - 1 -%} 
              {%- if gci.day < 1 -%} 
                {%- set gci.day = gci.day + 7 -%}
              {%- endif -%}
            {%- else -%} 
              {%- set gci.compareTime = 0 -%}
              {%- set gci.day = gci.day + 1 -%} 
              {%- if gci.day > 7 -%} 
                {%- set gci.day = gci.day - 7 -%}
              {%- endif -%}
            {%- endif -%}
            {%- if dayoffset == 0 -%}
              {%- set gci.day = startday -%} 
              {%- set gci.compareTime = ns.jetzt.strftime('%H%M')|int -%} 
            {%- endif -%}
            {%- set gci.result = getDayPlan(dayoffset, planName, gci.day, mode, 0)|from_json -%}
            {#
            {%- set ns.debug = ns.debug ~ "result gci "~ gci.day ~" " ~ dayoffset ~" = " ~ gci.result ~"<br>"-%}
            #}
            {%- if gci.result != none -%}
              {%- set gci.result = getPlanItem(gci.result, gci.compareTime, mode)|from_json -%} 
        
              {%- if gci.result != none -%}
                {%- break -%}
              {%- endif -%}  
            {%- endif -%}  
          {% endfor %}
          {{- gci.result|to_json -}} 
        {%- endmacro -%}
        {#- ___________________________________________________ -#}
        
        
        {#- ___________________________________________________ -#}
        {%- set ns = namespace() -%}
        {%- set ns.cfg = myConfig.weekplans -%}
        {%- set ns.result = "false" -%}
        {%- set ns.debug = "<ul>" -%}
        {%- set ns.jetzt = now() -%}
        {%- set ns.midnight = strptime(ns.jetzt.strftime('%d-%m-%Y'), "%d-%m-%Y") -%}
        {%- set ns.current = [] -%}        
        {%- set ns.next = "-" -%}        
        
        {%- set ns.debug = ns.cfg|to_json -%}
        
        {%- if "timer" in ns.cfg and ns.cfg["timer"] != "-" and states(ns.cfg["timer"]) != "unknown" and "plans" in ns.cfg -%}
          {%- set ns.weekplans = convert2Object(ns.cfg["plans"])|from_json -%}
          {%- set days = [7,1,2,3,4,5,6] -%}
          {%- set today = days[ns.jetzt.strftime('%w')|int] -%}
          {%- set ns.next = 0 -%}
          {%- if ns.weekplans is mapping -%}
            {% set ns.debug = ns.debug ~ "\n<li>last Weekplan Type:"  ~ " mapping </li>" %}
          {%- elif ns.weekplans is list -%}
            {% set ns.debug = ns.debug ~ "\n<li>last Weekplan Type:"  ~ " list </li>" %}
          {%- elif ns.weekplans is string -%}
            {% set ns.debug = ns.debug ~ "\n<li>last Weekplan Type:"  ~ " string </li>" %}
            {% set ns.debug = ns.debug ~ "\n<li>last Weekplan Plan:" ~ ns.weekplans ~ " string </li>" %}
          {%- endif -%}
          {%- for WPname, plan in ns.weekplans.items()-%}
            {%- set ns.zeit = getcurrentItemFromPlan(WPname, today, "next")|from_json -%}        
            {%- if ns.zeit != none -%}
              {%- set tp = ns.zeit.secondsFromNow|int + weekplan_delay_seconds|int -%}
              {%- if not ns.next  or ns.next > tp or ns.next == 0-%}{%- set ns.next = tp -%}{%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          
          {%- for WPname, plan in ns.weekplans.items()-%}
            {%- set cur = getcurrentItemFromPlan(WPname, today, "last")|from_json -%}
            {%- if cur != none -%}
              {%- set ns.current = ns.current + [{WPname:cur}] -%}
            {%- endif -%}
          {%- endfor -%}        
          
          
          {%- set dann = (ns.jetzt + timedelta(seconds=ns.next|int)) -%}
          {%- set ns.event_debug = "<ul><li>" ~ dann.strftime("%d-%m-%Y %H:%M") ~ " [" ~ (ns.next/60)|round|int ~ "min]</li></ul>" -%}
        
          {%- set ns.status = "<ul>" -%}
          {%- for item in ns.current -%}
            {%- for key, val in item.items()-%}
              {%- set ns.status = ns.status ~ "<li>" ~ key ~ ": " ~ val ~ "</li>" -%}
            {%- endfor -%}
          {%- endfor -%}
          {%- set ns.status = ns.status ~ "</ul>" -%}
        {#   
         #}
          
          {% set ns.debug = ns.debug ~ "\n<li>last Weekplan Status:" ~ ns.status ~ "</li>" %}
          {% set ns.debug = ns.debug ~ "\n<li>next Weekplan Event:" ~  ns.event_debug ~  "</li>" %}
          {% set ns.debug = ns.debug ~ "\n<li>current:" ~  ns.current ~  "</li>" %}
          
        
          {%- set ns.debug = ns.debug ~ "</ul>" -%}
        
        
          {{ {"next": ns.next, "current": ns.current, "debug": ns.debug } }}
        {%- else -%}
          {{ {"next": false, "current": false, "debug": "<ul><li>no weekplan in use</li></ul>" } }}
        {%- endif -%}

      numbersystem: "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÜabcdefghijklmnopqrstuvwxyzäöü<>@#+/!§$%&/()=?"

      mySettings: >-
        {# ___________________________________________________ #}
        {%- macro convert2Object(obj={}) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.obj = obj -%}
          {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
          {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
          {%- if nsm.obj is string  -%}
            {%- if nsm.obj is search(patternList) or nsm.obj is search(patternMap) -%}
                {%- set nsm.obj = nsm.obj|replace("'", '"') -%}
            {%- else -%}
                {%- set nsm.obj = [nsm.obj] |to_json-%}
            {%- endif -%}
          {%- elif nsm.obj is number  -%}
            {%- set nsm.obj = [nsm.obj] |to_json -%}
          {%- elif nsm.obj is mapping or nsm.obj is list   -%}
            {%- set nsm.obj = nsm.obj |to_json -%}
          {%- endif -%}
          {{- nsm.obj -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {# ___________________________________________________ #}
        {%- macro checkDiveLevelInObject(obj=none, levels=[], lasttype=none) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.obj = obj -%}
          {%- set nsm.result = 0 -%}
          {%- for level in levels -%}
            {%- if nsm.obj is mapping and level in nsm.obj -%}
                {%- set nsm.obj = nsm.obj[level] -%}
            {%- else -%}
                {%- set nsm.result = 1 -%}
                {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if lasttype is string and nsm.result == 0 -%}
            {%- set nsm.result = 2 -%}
            {%- if lasttype == "list" and nsm.obj is list -%}
                {%- set nsm.result = 0 -%}
            {%- elif lasttype == "dict" and nsm.obj is mapping -%}
                {%- set nsm.result = 0 -%}
            {%- elif lasttype == "string" and nsm.obj is string -%}
                {%- set nsm.result = 0 -%}
            {%- elif lasttype == "number" and nsm.obj is number -%}
                {%- set nsm.result = 0 -%}
            {%- else -%}
              {%- set nsm.result = 3 -%}
            {%- endif -%}
          {%- endif -%}
          {{- nsm.result -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {# ___________________________________________________ #}
        {%- macro numberS_from_Dezi(val, basis=false) -%}
          {%- set ns = namespace() -%}
          {%- set ns.result = "" -%}
         
          {%- set ns.system = false -%}
          {%- set ns.val = val|int -%}
         
          {%- if basis is false -%}
            {%- if numbersystem is defined -%}
              {%- set ns.system = numbersystem -%}
            {%- endif -%}
          {%- else -%}
            {%- set ns.system = basis -%}
          {%- endif -%}
        
          {%- if ns.system is not false and ns.val is number -%}
            {%- set ns.basis = ns.system|length -%}
            {%- for x in range(1000) -%}
              {%- set mod = ( ns.val % ns.basis ) -%}
              {%- set result = ( ns.val / ns.basis ) | round(0,"floor") -%}
              {%- if result == 0 -%}
                {%- set ns.result = ns.system[mod] ~ ns.result  -%}
                {%- break -%}
              {%- endif -%}
              {%- set ns.result = ns.system[mod] + ns.result  -%}
              {%- set ns.val = result -%}   
            {%- endfor -%}
          {%- endif -%}
          
          {{- ns.result -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {# ___________________________________________________ #}
        {%- macro numberS_to_Dezi(val, basis=false) -%}
          {%- set ns = namespace() -%}
          {%- set ns.result = 0 -%}
         
          {%- set ns.system = false -%}
          {%- set ns.val = val|string -%}
         
          {%- if basis is false -%}
            {%- if numbersystem is defined -%}
              {%- set ns.system = numbersystem -%}
            {%- endif -%}
          {%- else -%}
            {%- set ns.system = basis -%}
          {%- endif -%}
        
          {%- if ns.system is not false and ns.val | length > 0 -%} 
            {%- set ns.basis = ns.system|length -%}
            {%- set L = ns.val | length -%}
            {%- for x in range(L) -%}
              {%- set sign = ns.val[L-(1+x)] -%}
              {%- set sign = ns.system.index(sign)*ns.basis**x -%}
              {%- set ns.result = ns.result + sign  -%}
            {%- endfor -%}
         
          {%- endif -%}
         
          {{- ns.result -}}
          
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {# ___________________________________________________ #}
        {%- macro isCmdString(val) -%}
          {%- if val is string and val is search(cmdStrTstPatternDict) -%}
            {{- val -}}
          {%- else -%}
            {{- "{}" -}}
          {%- endif -%}              
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getFormated(val) -%}
          {%- if val is number -%}
            {{- val -}}
          {%- else -%}
            {{- "\"" ~ val ~ "\"" -}}
          {%- endif -%}              
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getName(personid) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.fName = state_attr(personid, "friendly_name") -%}
          {%- if nsm.fName == None -%}
            {%- set tmp = personid.split(".") -%}
            {%- set pos = tmp|length -%}
            {%- set tmp = tmp[pos-1].split("_") -%}
            {%- set pos = tmp|length -%}
            {%- if tmp|length > 1 and  tmp[pos-1]|int(-1) != -1 -%}
              {%- set nsm.fName = tmp[pos-2] ~ "_" ~ tmp[pos-1] -%}
            {%- else -%}
              {%- set nsm.fName = tmp[pos-1] -%}
            {%- endif -%}              
          {%- endif -%}
          {{-nsm.fName-}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro sortVal(val1, val2) -%}
          {%- set _sortValNS = namespace() -%}
        
        
          {%- set srch1 = (val1|string).split(">") -%}
          {%- set srch2 = (val2|string).split(">") -%}
          {%- set _sortValNS.retVal = none -%}
          {%- set pattern = "^!.*$" -%}
        
          {%- if srch1[0]|string is search(pattern)  -%}
            {%- set _sortValNS.retVal = val1 -%}
          {%- elif srch2[0]|string is search(pattern) -%}
            {%- set _sortValNS.retVal = val2 -%}
          {%- else -%}
            {%- for seq in ns.sequence|reverse -%}
              {%- if seq == srch1[0] and seq != srch2[0] -%}
                {%- set _sortValNS.retVal = val1 -%}
                {%- break -%}
        
              {%- elif seq == srch2[0] and seq != srch1[0] -%}
                {%- set _sortValNS.retVal = val2 -%}
                {%- break -%}
        
              {%- elif seq == srch1[0] and seq == srch2[0] -%}
                {%- for item in [val1, val2 ]|sort(case_sensitive=false) -%}
                  {%- set _sortValNS.retVal = item -%}
                  {%- break -%}
                {%- endfor -%}                   
                {%- break -%}
                
              {%- elif seq == "T" -%}
                {%- if val1|string is search(cmdStrTstPatternNumP) and val2|string is search(cmdStrTstPatternNumP) -%}
                  {%- if val1|float > val2|float -%}  {%- set _sortValNS.retVal = val1 -%} {%- else -%}  {%- set _sortValNS.retVal = val2 -%} {%- endif -%}           
                  {%- break -%}      
                {%- elif val1|string is search(cmdStrTstPatternNumP) -%}
                  {%- set _sortValNS.retVal = val1 -%}          
                  {%- break -%}      
                {%- elif val2|string is search(cmdStrTstPatternNumP) -%}
                  {%- set _sortValNS.retVal = val2 -%}         
                  {%- break -%}      
                {%- endif -%}
        
              {%- elif seq == "V" -%}
                {%- set keys = ["a","e","c"] -%}
                {%- set pattern = "^[" ~ keys|join ~"]$" -%}
                {%- if val1|string is search(pattern) and val2|string is search(pattern) -%}
                  {%- if keys.index(val1) > keys.index(val2) -%}  {%- set _sortValNS.retVal = val1 -%} {%- else -%}  {%- set _sortValNS.retVal = val2 -%} {%- endif -%}           
                  {%- break -%}      
                {%- elif val1|string is search(pattern) -%}
                  {%- set _sortValNS.retVal = val1 -%}          
                  {%- break -%}      
                {%- elif val2|string is search(pattern) -%}
                  {%- set _sortValNS.retVal = val2 -%}         
                  {%- break -%}      
                {%- endif -%} 
        
              {%- endif -%}           
            {%- endfor -%}
          {%- endif -%}
          {%- if not _sortValNS.retVal -%}{%- set _sortValNS.retVal = val1 -%} {%- endif -%}
          {{- _sortValNS.retVal -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getSettings(sName, sState, sCmd) -%}
          {%- set myCmd = convert2Object(sCmd)|from_json -%}
          {%- if myCmd[sName] is defined and myCmd[sName][sState] is defined -%} 
            {{- myCmd[sName][sState]|to_json -}}
          {%- endif -%}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro translateAction(action) -%}
        {%- set tA = namespace() -%}
        {%- set tA.action = action|string or "" -%}
        {%- for counter in range(0 , 4 ) -%}
          {%- if tA.action is string and tA.action is search("^WP>.+$") -%}
            {%- set plan = tA.action[3:] -%}
            {%- if myWeekplan is defined and myWeekplan is mapping and myWeekplan.current is list -%}
              {%- for wpItem in myWeekplan.current -%}
                {%- if wpItem is defined and wpItem is mapping -%}
                  {%- for wpItemKey in wpItem -%}
                  {%- if wpItemKey == plan -%}
                    {%- set tA.action = wpItem[wpItemKey].action -%}
                  {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- elif tA.action is string and tA.action is search(cmdStrTstPatternNumPK) -%}
            {%- set tA.action = tA.action.replace(",",".")|float|round(1)|string -%}
          {%- else -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        
        {{- tA.action -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro mergeCmd(m1Cmd, m2Cmd) -%}
          {%- set mC = namespace() -%}
          {%- set myCmd1 = convert2Object(m1Cmd)|from_json -%}
          {%- set myCmd2 = convert2Object(m2Cmd)|from_json -%}
          {%- set mC.myCmd = "" -%}
          {%- set mC.komma = "" -%}
        
          {%- for room in myCmd1 -%}
            {%- set mC.action1 = translateAction(myCmd1[room]) -%}
            {%- if mC.myCmd|length > 0 -%}{%- set mC.komma = ", " -%}{%- else -%}{%- set mC.komma = "" -%}{%- endif -%}  
            {%- if myCmd2[room] is not defined -%}
              {%- set mC.myCmd = mC.myCmd ~ mC.komma ~ "\"" ~room ~ "\"" ~ ":" ~ getFormated(mC.action1) -%}                      
            {%- endif -%}      
          {%- endfor -%}  
        
          {%- for room in myCmd2 -%}
            {%- set mC.action2 = translateAction(myCmd2[room]) -%}
            {%- if mC.myCmd|length > 0 -%}{%- set mC.komma = ", " -%}{%- else -%}{%- set mC.komma = "" -%}{%- endif -%}  
            {%- if myCmd1[room] is not defined -%} 
              {%- set mC.myCmd = mC.myCmd ~ mC.komma ~ "\"" ~room ~ "\"" ~ ":" ~ getFormated(mC.action2) -%} 
            {%- else -%}
              {%- set mC.action1 = translateAction(myCmd1[room]) -%}
              {%- set val=sortVal(mC.action1|string, mC.action2|string) -%}
              {%- if val -%} 
                {%- set mC.myCmd = mC.myCmd ~ mC.komma ~ "\"" ~room ~ "\"" ~ ":" ~ getFormated(val) -%} 
              {%- endif -%}      
            {%- endif -%}      
          {%- endfor -%}
        
          {{- "{" ~ mC.myCmd ~ "}" -}}
             
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getPartOfAttr(c_dev, c_attr, c_splitter, c_pos, c_default=none) -%}
        
          {%- set myattr = state_attr(c_dev, c_attr) -%}
          {%- if myattr and myattr is search(c_splitter) -%}
            {%- set myattr = myattr.split(c_splitter) -%}
            {%- if myattr is list and myattr|length > (c_pos+1) -%}{%- set myattr = myattr[c_pos] -%} {%- else -%}{%- set myattr = none -%}{%- endif -%}
          {%- else -%}
            {%- set myattr = c_default -%}       
          {%- endif -%}        
          {{- myattr -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getAction(cmd, device) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.cmd = cmd -%}
          {%- set nsm.action = cmd -%}
          {%- set nsm.mode = "" -%}
          {%- set nsm.result = {} -%}
               
          {%- if nsm.cmd is search("^!.*$") -%}
            {%- set nsm.cmd = nsm.cmd[1:] -%}
          {%- endif -%}
        
          {%- if nsm.cmd is search("^P>\d$") -%}
            {%- set nsm.result = {"action": nsm.cmd[2:3], "mode": "program"} -%}
        
          {%- elif  nsm.cmd is search("^WP>[A-Za-z\d_]+?$") -%}
            {%- set nsm.result = {"action": nsm.cmd[3:], "mode": "weekplan"} -%}
        
          {%- elif  nsm.cmd == "off"  -%}
            {%- set nsm.result = {"action": none, "mode": "off"} -%}
        
          {%- elif  nsm.cmd is search("^boost>") -%}
            {%- set nsm.result = {"action": nsm.cmd[7:], "mode": "boost"} -%}
        
          {%- else -%}
            {%- set nsm.temp = "" -%}
            {%- if  nsm.cmd is search(cmdStrTstPatternNumP)  or nsm.cmd is number -%}
              {%- set nsm.temp = nsm.cmd|string|float -%}
            {%- elif  nsm.cmd is search("^e") and "eco" in device -%}
              {%- set nsm.temp = device.eco|string|float -%}
            {%- elif  nsm.cmd is search("^c") and "comfort" in device -%}
              {%- set nsm.temp = device.comfort|string|float -%}
            {%- elif  nsm.cmd is search("^a") and "away" in device -%}
              {%- set nsm.temp = device.away|string|float -%}
            {%- endif -%}
            {%- if nsm.temp is number and ( nsm.temp != device.target_temperatur or device.state != "heat") -%}
              {%- set nsm.result = {"action": nsm.temp, "mode": "temp" } -%}
            {%- else -%}
              {%- set nsm.result = {"action": nsm.temp, "mode": "doNothing"} -%}
            {%- endif -%}
        
          {%- endif -%}
        
          {{- nsm.result|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        
        {# ___________________________________________________ #}
        {%- macro getSpecials_homematicHM(id) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.result = {} -%}
          {%- set subdevs = states.select | selectattr('entity_id', 'search', 'presetmodes$') | map(attribute='entity_id')|list -%}
          {%- set name = state_attr(id, 'friendly_name').split(" ") -%}
          {%- if name is list and name|length > 0 -%}
            {%- set name = name[0] ~ "_presetModes"-%}
            {%- for subdev in subdevs -%}
              {%- if state_attr(subdev, 'friendly_name') == name -%}
                {%- set nsm.result = dict(nsm.result, **{"subdev":subdev}) -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {{- nsm.result|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        
        {# ___________________________________________________ #}
        {%- macro createAction(device) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.result = {} -%}
        
          {%- if "commands" in device and device.commands is mapping and device.commands|length > 0 -%}
            {%- set nsm.cmd  =  "" -%}
            {%- for key, cmd in device.commands.items() -%}
              {%- if loop.index == 1 -%}
                {%- set nsm.cmd  =  cmd -%}
              {%- else -%}
                {%- set nsm.cmd=sortVal(nsm.cmd|string, cmd|string) -%}
              {%- endif -%}    
            {%- endfor -%}
            {%- if nsm.cmd and nsm.cmd != "" -%}
              {%- set nsm.result = {
                "device": device.id,
                "integration": getPartOfAttr( device.id, "interface_id", '-', 0, "-"), 
                "class": getPartOfAttr( device.id, "model", '-', 0, "-"), 
                "deviceID": device_id(device.id), 
                "current_temperatur": state_attr(device.id, "current_temperature"),
                "target_temperatur": state_attr(device.id, "temperature"),
                "hvac_modes": state_attr(device.id, "hvac_modes"),
                "hvac_action": state_attr(device.id, "hvac_action"),
                "preset_modes": state_attr(device.id, "preset_modes"),
                "state": states(device.id),
                "cmd": nsm.cmd, 
                "subdevice": none, 
                "submode": none, 
                "mode": none, 
                "action" : none
                }
                -%}
              {%- set nsm.result = dict(device, **nsm.result) -%}
          
              {# handle specials of some devices #}
              {%- set nsm.specials  = {} -%}
              {%- if nsm.class == "HM" and nsm.integration == "homematic" -%}  
                {%- set nsm.specials  = getSpecials_homematicHM()|from_json -%}
              {%- endif -%}
              {%- set nsm.result = dict(nsm.result, **nsm.specials) -%}
        
              {%- set nsm.mycmds = getAction(nsm.cmd, nsm.result)|from_json -%}
              {%- if  mode in nsm.mycmds and nsm.mycmds.mode == "boost" -%}
                {%- set subcmds = getAction(nsm.mycmds.action, nsm.result)|from_json -%}
                {%- set nsm.mycmds = dict(nsm.mycmds, **{"submode":subcmds.mode, "action":subcmds.action}) -%}
              {%- endif -%}
              {%- set nsm.result = dict(nsm.result, **nsm.mycmds) -%}
        
            {%- endif -%}
          {%- endif -%}
          {{- nsm.result|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getTempOfClass(classes, config) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.temps = {} -%}
          {%- set nsm.temp = None -%}
          {%- set nsm.faders = {} -%}
        
          {%- if "faders" in config -%}
            {%- set nsm.faders = config.faders -%}  
          {%- endif -%}
          {%- for key in classes -%}
            {%- set nsm.temp = none -%}
            {%- if key in config and ( config[key] is number or ( config[key] is string and config[key] is search(cmdStrTstPatternNumPK) ) ) -%}
              {%- set nsm.temp = config[key] -%}
            {%- endif -%}
            {%- if key in nsm.faders -%}
              {%- if nsm.faders[key] is string and states(nsm.faders[key]) != "unknown" -%}
                {%- set nsm.temp = states(nsm.faders[key]) -%}
              {%- elif nsm.faders[key] is list and nsm.faders[key]|length > 0 and states(nsm.faders[key][0]) != "unknown" -%}
                {%- set nsm.temp = states(nsm.faders[key][0]) -%}
              {%- endif -%}
            {%- endif -%}
            {%- if nsm.temp and nsm.temp != none -%}
              {%- set item = {key:nsm.temp|string|replace(",",".")|float|round(1)} -%}
              {%- set nsm.temps = dict(nsm.temps, **item) -%}
            {%- endif -%}
          {%- endfor -%}
        
          {{- nsm.temps|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        {# ___________________________________________________ #}
        {%- macro createDeviceDict_getItem(device, devClass, counter, content) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.tempDevice = dict({}, **content) -%}
          {%- set nsm.advancedDevConfig = {} if not "advancedDeviceConfig" in myConfig else myConfig.advancedDeviceConfig -%}
        
          {%- set nsm.deviceName = state_attr(device, 'friendly_name') -%}
        
          {%- set nsm.deviceConfig = {} -%}
          {%- for key, val in nsm.advancedDevConfig.items() -%}
            {%- if nsm.deviceName is match(key) -%}
              {%- set nsm.deviceConfig = val -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        
          {%- set nsm.deviceClass = {} if not devClass in myConfig.config else myConfig.config[devClass] -%}
        
          {%- set nsm.tempDevice =  dict( nsm.tempDevice, **nsm.deviceClass ) -%}
          {%- set nsm.tempDevice =  dict( nsm.tempDevice, **content ) -%}
        
          {%- set nsm.tempDevice =  dict( nsm.tempDevice, **{
                                              "name": nsm.deviceName, 
                                              "_config": nsm.deviceConfig, 
                                              "id": device, 
                                              "tgheatingID": numberS_from_Dezi(counter)
                                              } )  -%}
          {%- if devClass in ["climate"] -%}                                    
            {%- set nsm.tempDevice = dict(nsm.tempDevice, **getTempOfClass(var_temp_classes.keys(), nsm.tempDevice._config)|from_json) -%}
          {%- endif -%}
        
        {{- nsm.tempDevice|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro createDeviceDict(devices) -%}
          {%- set nsm = namespace() -%}
          {%- set nsm.devices = {} -%}
          {%- set nsm.advancedDevConfig = {} if not "advancedDeviceConfig" in myConfig else myConfig.advancedDeviceConfig -%}
          {%- if nsm.advancedDevConfig is string -%}
            {%- if nsm.advancedDevConfig is search(cmdStrTstPatternDict) -%}
              {%- set nsm.advancedDevConfig = nsm.advancedDevConfig|replace("'", '"')|from_json -%}
            {%- else -%}
              {%- set nsm.advancedDevConfig = {} -%}
            {%- endif -%}
          {%- elif not (nsm.advancedDevConfig is mapping) -%}
            {%- set nsm.advancedDevConfig = {} -%}
          {%- endif -%}
          {%- set nsm.counter = 1 -%}
          {%- for deviceClass in myConfig.devices.keys()|sort -%}
            {%- set items = myConfig.devices[deviceClass] -%}
            {%- set nsm.tempDevices = {} -%}
            {%- if items is list -%}
              {%- for item in items|sort -%}
                {%- if states(item) != "unknown"  -%}
                  {%- set device = createDeviceDict_getItem(item, deviceClass, nsm.counter, {})|from_json -%}
                  {%- if device != false  -%}
                    {%- set nsm.counter = nsm.counter + 1 -%}
                    {%- set nsm.tempDevices = dict(nsm.tempDevices, **{item:device}) -%}                  
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- elif items is mapping -%}
              {%- for item in items.keys()|sort -%}
                {%- if states(item) != "unknown"  -%}
                  {%- set device = createDeviceDict_getItem(item, deviceClass, nsm.counter, items[item])|from_json -%}
                  {%- if device != false  -%}
                    {%- set nsm.counter = nsm.counter + 1 -%}
                    {%- set nsm.tempDevices = dict(nsm.tempDevices, **{item:device}) -%}                  
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set nsm.devices = dict(nsm.devices, **{deviceClass: nsm.tempDevices}) -%}
          {%- endfor -%}
          {%- set devices = dict(devices, **nsm.devices) -%}
        {{- devices|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro getIntegration(id) -%}
        {%- set gi = namespace() -%}
        {%- set gi.usedIntegrations = ["homematicip_local"] -%}
        {%- set gi.integrations = [] -%}
        {%- set gi.integration = "else" -%}
        {#
        
        {%- for key in gi.usedIntegrations -%}
          {%- if not key in gi.integrations|map(attribute='key')|list -%}
            {%- set gi.integrations = gi.integrations + [{"key": key, "dev": integration_entities(key)}] -%}    
          {%- endif -%}
        {%- endfor -%}
              {%- set tmp.myintegration = "else" -%}
              {%- for integration in tmp.integrations -%}
                {%- if integration.dev and integration.key and id in integration.dev -%}
                  {%- set tmp.myintegration = integration.key -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
        
        #}
        {{- gi.integration -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        {# ___________________________________________________ #}
        {%- macro checkOverdrivers(device) -%}
          {%- set ns = namespace() -%}
          {%- set ns.overdrivers = [] -%}
          {%- set ns.overdriversTemp = ["test"] -%}
        
          {%- if checkDiveLevelInObject(device, ["_config", "faders", "overdrive"], "string" )|int == 0 -%}
            {%- set ns.overdriversTemp = [device._config.faders.overdrive] -%}
          {%- elif checkDiveLevelInObject(device, ["_config", "faders", "overdrive"], "list")|int == 0 -%}
            {%- set ns.overdriversTemp = device._config.faders.overdrive -%}
          {%- endif -%}
          {%- for driver in ns.overdriversTemp -%}
            {%- if states(driver) != "unknown" -%}
              {%- set ns.overdrivers = ns.overdrivers + [driver] -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if ns.overdrivers | length == 0 -%}
            {%- set ns.overdrivers = "false" -%}
          {%- endif -%}
          {{- {"overdrivers":ns.overdrivers}|to_json -}}
        {%- endmacro -%}
        {# ___________________________________________________ #}
        
        
        {%- set ns = namespace() -%}
        {%- set tmp = namespace() -%}
        {%- set ns.debug = "" -%}
        {%- set ns.jetzt = now() -%}
        {%- set ns.jetzt_Min_Timestamp = ((ns.jetzt | as_timestamp ) / 60)|int  -%}
        
        {%- if myConfig.defaultCmd is string -%}
          {%- set ns.cmd = myConfig.defaultCmd|from_json -%}
        {%- elif myConfig.defaultCmd is mapping -%}
          {%- set ns.cmd = myConfig.defaultCmd -%}
        {%- else -%}
          {%- set ns.cmd = {} -%}
        {%- endif -%}
        {%- set ns.sequence = myConfig.sequence -%}
        
        {# split statefile input #}
        {%- set ns.debug = ns.debug ~ myConfig.statefilestate -%}
        {%- set tmp.input = {} -%}
        {%- set ns.statefile = myConfig.statefilestate -%}
        {%- set tmp.timeFilteredCategories=["o"] -%}
        
        {%- for category in myConfig.statefilestate.input.split('|') -%}
          {%- set keyval = category.split(':') -%}
          {%- if keyval|length == 2 -%}
            {%- set tmp.catname = keyval[0] -%}
            {%- set tmp.catItems = {} -%}
            {%- for catval in keyval[1].split(';') -%}
              {%- set item = catval.split('.') -%}
              {%- if item|length == 2 -%}
                {%- if not tmp.catname in tmp.timeFilteredCategories -%}
                  {%- set tmp.catItems = dict(tmp.catItems, **{item[0]: numberS_to_Dezi(item[1]) }) -%}
                {%- elif numberS_to_Dezi(item[1]) >  ns.jetzt_Min_Timestamp -%}
                  {%- set tmp.catItems = dict(tmp.catItems, **{item[0]: numberS_to_Dezi(item[1]) }) -%}
                {%- endif -%}    
              {%- endif -%}    
            {%- endfor -%}
            {%- set tmp.input = dict(tmp.input, **{tmp.catname: tmp.catItems}) -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns.statefile = dict(ns.statefile, **{"output":tmp.input}) -%}
        
        {%- set ns.usersettings = [] -%}
        
        {%- set ns.weekplanes = myWeekplan -%}
        {# ---------die advanced Device Config wird aufbereitet--------#}
        {%- set ns.devices = {"climate":{}, "switches": {} } -%}
        {%- set ns.devices = createDeviceDict(ns.devices)|from_json -%}
        
        {%- set ns.debug = ns.debug ~ ns.devices -%}
        
        
        {# ---------ns.cmd wird über die Switches befüllt/geändert, wenn mode exclusiv == true > break--------#}
        {%- set ns.userbreak = false -%}
        {%- for switchname in ns.devices.switches | sort(attribute='position') | list -%}
          {%- set switch = ns.devices.switches[switchname] -%}
          {%- if "device" in switch and switch.device != "-" -%}
            {%- if "on_cmd" in switch -%}{%- set onCmd = isCmdString(switch.on_cmd) -%}{%- else -%}{%- set onCmd = "{}" -%}{%- endif -%}
            {%- if "off_cmd" in switch -%}{%- set offCmd = isCmdString(switch.off_cmd) -%}{%- else -%}{%- set offCmd = "{}" -%}{%- endif -%}
            {%- if "on_mode" in switch and switch.on_mode -%}{%- set onMode = True -%}{%- else -%}{%- set onMode = False -%}{%- endif -%}
            {%- if "off_mode" in switch and switch.off_mode -%}{%- set offMode = True -%}{%- else -%}{%- set offMode = False -%}{%- endif -%}           
            {%- if states(switch.device) == "on" -%}
              {%- set ns.cmd = mergeCmd(ns.cmd, onCmd)|from_json -%}
              {%- if onMode -%}
                {%- set ns.userbreak = true -%}
                {%- break -%}
              {%- endif -%}
            {%- elif states(switch.device) == "off" -%}
              {%- set ns.cmd = mergeCmd(ns.cmd, offCmd)|from_json -%}
              {%- if offMode -%}
                {%- set ns.userbreak = true -%}
                {%- break -%}
              {%- endif -%}
            {%- else -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {# ns.cmd wird über den Status der persons befüllt/geändert wenn kein switch den mode exclusiv auf true hatte #}
        {%- set ns.debug = ns.debug ~ "<br>userbreak: " ~ ns.userbreak|string -%}
        {%- set ns.debug = ns.debug ~ "<br>persons in devices: " ~ ("persons" in ns.devices)|string -%}
        
        {%- if not ns.userbreak and "persons" in ns.devices -%}
          {%- set ns.usercmd = "{}" -%}
          {%- set ns.debug = ns.debug ~ "<br>Personen-Logik wird ausgeführt" -%}
        
          {%- for persondevice, person in ns.devices.persons.items() -%}
            {%- set name = getName(persondevice) if not ("name" in person and person.name is string and person.name|length > 0) else person.name  -%}
            {%- set state = states(persondevice) -%}
            {%- set ns.debug = ns.debug ~ "<br>persondevice: " ~ persondevice ~ ", raw state: " ~ state ~ ", name: " ~ name -%}
            {%- set mystates = state.split("!") -%}
            {%- if mystates is list and mystates|length > 1 -%}
              {%- set state = mystates[1] -%}
              {%- set name = mystates[0] -%}
              {%- set ns.debug = ns.debug ~ "<br>Nach Split: name='" ~ name ~ "', state='" ~ state ~ "'" -%}
            {%- else -%}
              {%- set ns.debug = ns.debug ~ "<br>Kein '!' im Status gefunden, verwende getName()" -%}
            {%- endif -%}
            {%- set ns.usercmd = getSettings(name, state, myConfig.cmd) -%}
            {%- set ns.debug = ns.debug ~ "<br>getSettings('" ~ name ~ "', '" ~ state ~ "', cmd) = " ~ (ns.usercmd|string if ns.usercmd else "NICHT GEFUNDEN") -%}
            {%- set ns.usersettings = ns.usersettings + [{"name": name, "state":state, "cmd":ns.usercmd }] -%}
        
            {%- if not ns.usercmd -%}
              {%- set ns.usercmd = "{}" -%}
            {%- else -%}
            {%- endif -%}   
            {%- set ns.cmd = mergeCmd(ns.cmd, ns.usercmd)|from_json -%}
        
          {%- endfor -%}
        
        {%- else -%}
          {%- if ns.userbreak -%}
            {%- set ns.debug = ns.debug ~ "<br>Personen-Logik übersprungen: userbreak=true (Switch im exklusiven Modus)" -%}
          {%- elif not ("persons" in ns.devices) -%}
            {%- set ns.debug = ns.debug ~ "<br>Personen-Logik übersprungen: keine persons in devices" -%}
          {%- endif -%}
        {%- endif -%}
        {# {%- set ns.cmd = ns.cmd|replace("'", '"')|from_json -%} #}
        {# {%- set ns.cmd = ns.cmd|from_json -%} #}
        
        {#
        {%- set ns.overdrived = myConfig.statefilestate.input.od -%}
        {%- set ns.overdrived = {} -%}
        {%- if checkDiveLevelInObject(myConfig,["statefilestate","input","od"]) == 0 and myConfig.statefilestate.input.od is mapping%}
          {%- set ns.overdrived = myConfig.statefilestate.input.od -%}
        {%- endif -%}
        #}
        
        {%- set ns.climates = ns.devices["climate"] -%}
        {%- set tmp.devices = {} -%}
        {%- set ns.deviceCommandsDebug = {} -%}
        {%- if myConfig.triggerClass == "overdrive" -%} 
        {# 
          {%- set tmp.output = {} if not ("output" in ns.statefile and ns.statefile.output is mapping) else ns.statefile.output -%}
          {%- set tmp.outputO = {} if not ("o" in tmp.output and tmp.output.o is mapping) else tmp.output.o -%}
          {%- set ns.debug = ns.debug ~ "overdrive detected <br>"  -%}
          {%- for id, device in ns.climates.items() -%}
            {%- if checkDiveLevelInObject(device, ["_config", "faders", "overdrive"] )|int == 0  and device._config.faders.overdrive == myConfig.triggerDevice -%}
              {%- set ns.debug = ns.debug ~ "<br>device detected " -%}
              {%- set tmp.device = device -%}
              {%- set tmp.device = dict(tmp.device, **{"commands":{"x":states(myConfig.triggerDevice)} }) -%}
              {%- set tmp.device = dict(tmp.device, **createAction(tmp.device)|from_json) -%}
              {%- set tmp.devices = dict(tmp.devices, **{id:tmp.device}) -%}
              {%- set tmp.dann = (ns.jetzt + timedelta( minutes=(device.overdriveduration|int ))).strftime('%d-%m-%Y %H:%M') -%}
              {%- set tmp.outputO = dict(tmp.outputO, **{tmp.device.tgheatingID:tmp.dann}) -%}
              {%- if  ( ns.weekplanes.next and ns.weekplanes.next is number and ns.weekplanes.next > device.overdriveduration ) or not ns.weekplanes.next -%}
                {%- set ns.weekplanes = dict(ns.weekplanes, **{"next":device.overdriveduration}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set tmp.output = dict(tmp.output, **{"o":tmp.outputO}) -%}
          {%- set ns.statefile = dict(ns.statefile, **{"output":tmp.output}) -%}
        #}
        
        {%- else -%}
          {%- set ns.deviceCommandsDebug = {} -%}
          {%- for id, device in ns.climates.items() -%}
            {%- set tmp.commands = {} -%}
            {%- set tmp.device = device -%}
            {%- if "commands" in tmp.device and tmp.device.commands is mapping -%}
              {%- set tmp.commands = tmp.device.commands -%}
            {%- endif -%}
            {%- if ns.cmd is string -%}
              {%- set ns.cmd = ns.cmd|from_json -%}
            {%- elif not (ns.cmd is mapping) -%}
              {%- set ns.cmd = {} -%}
            {%- endif -%}
            {%- for itm, val in ns.cmd.items() -%}
              {%- if tmp.device.name is match("^" ~ itm) -%}
                {%- set tmp.commands = dict(tmp.commands, **{itm:val}) -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set tmp.device = dict(tmp.device, **{"commands":tmp.commands}) -%}
            {%- set ns.deviceCommandsDebug = dict(ns.deviceCommandsDebug, **{tmp.device.name: tmp.commands}) -%}
            {%- set action = createAction(tmp.device)|from_json -%}
            {%- for key, val in action.items() -%}
              {%- set tmp.device = dict(tmp.device, **{key:val}) -%}
            {%- endfor -%} 
            {%- set tmp.device = dict(tmp.device, **checkOverdrivers(tmp.device)|from_json) -%}
            {%- set tmp.devices = dict(tmp.devices, **{id:tmp.device}) -%}
          {%- endfor -%}
        {%- endif -%}  
                        
        {%- set ns.devices = dict(ns.devices, **{"climate":tmp.devices}) -%}
        
        {# 
        {%- set ns.statefileOutput = "" -%}
        {%- for key, val in ns.statefile.items() -%}
          {%- set tmp.subTxt = "" -%}
          {%- if val is mapping -%}
            {%- for device, stamp in val.items() -%}
              {%- set trenner = ";" if tmp.subTxt|length > 0 else "" -%}
              {%- set tmp.subTxt = tmp.subTxt ~ trenner ~ device ~ "." ~ numberS_from_Dezi(stamp) -%}
              {%- set tmp.device = dict(tmp.device, **{key:val}) -%}
            {%- endfor -%}
          {%- endif -%}
          {%- set trenner = "|" if tmp.subTxt|length > 0 and ns.statefileOutput|length > 0 else "" -%}
          {%- set ns.statefileOutput = ns.statefileOutput ~ trenner ~ tmp.subTxt -%}
        {%- endfor -%} 
         #}
        {%- set ns.debug = "<hr>DEBUG" ~ ns.devices -%}
        {{- {"data": ns.cmd, "usersettings": ns.usersettings, "debug": ns.debug, "devices": ns.devices, "statefile": ns.statefile, "weekplanes": ns.weekplanes, "deviceCommandsDebug": ns.deviceCommandsDebug } -}}
        

  # Debug - Message  post    
  
  - variables:
      my_devicesMsg: >-
        {{ {}|to_json }}
  
  - if:
      - condition: template
        value_template: "{{ mySettings is mapping }}"
    then:
      # Debug - Message  post    
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - variables:
              myWeekplanDebugMsg: >-
                {# ___________________________________________________ #}
                {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
                  {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
                  {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
                
                  {%- set dump = namespace() -%} 
                  {%- set dump.tmp="" -%}
                  {%- set dump.val=val -%}
                  {%- set dump.valType=none -%}
                  {%- set myFilter=filter -%}
                  {%- set filter=[] -%}
                  {%- set thisStep=thisStep + 1 -%}
                  
                  {%- if thisStep > maxSteps -%}
                    {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                    {%- set dump.valType="json" -%}
                  {%- else -%}
                    {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                      {%- set dump.val=dump.val|replace("'", '"')|from_json -%}
                    {%- endif -%}
                    {%- if dump.val is list -%}
                      {%- set dump.valType="list" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for item in dump.val -%}
                        {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                        {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is mapping -%}
                      {%- set dump.valType="dict" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for name, item in dump.val.items() -%}
                        {%- if thisStep > 1 or name not in myFilter -%}
                          {%- set preTxt = "<li>" -%}
                          {%- set postTxt = "</li>" -%}
                          {%- set nameTxtStart = "<b>" -%}
                          {%- set NameTxtEnd = "</b>" -%}
                          {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                          {%- if details == thisStep and myDump[0] == "dict" -%}
                            {%- set preTxt = preTxt ~ "<details>" -%}
                            {%- set postTxt = "</details>" ~ postTxt -%}
                            {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                            {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                          {%- endif -%}
                
                          {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is string or dump.val is number -%}
                      {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%} 
                      {%- set dump.valType="string" -%}
                    {%- endif -%}
                  {%- endif -%}
                
                  {%- if thisStep == 1 -%}
                    {{- dump.tmp -}}
                  {%- else -%}
                    {{- [dump.valType, dump.tmp]|to_json -}}
                  {%- endif -%}
                {%- endmacro -%}
                
                {{ "<u>Weekplans</u><br>" ~ dumpToHTML(myWeekplan, ["debug"], 5, true, 3) }}
                
              mySettingsDebugMsg: >-
                {# ___________________________________________________ #}
                {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
                  {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
                  {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
                
                  {%- set dump = namespace() -%} 
                  {%- set dump.tmp="" -%}
                  {%- set dump.val=val -%}
                  {%- set dump.valType=none -%}
                  {%- set myFilter=filter -%}
                  {%- set filter=[] -%}
                  {%- set thisStep=thisStep + 1 -%}
                  
                  {%- if thisStep > maxSteps -%}
                    {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                    {%- set dump.valType="json" -%}
                  {%- else -%}
                    {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                      {%- set dump.val=dump.val|replace("'", '"')|from_json -%}
                    {%- endif -%}
                    {%- if dump.val is list -%}
                      {%- set dump.valType="list" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for item in dump.val -%}
                        {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                        {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is mapping -%}
                      {%- set dump.valType="dict" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for name, item in dump.val.items() -%}
                        {%- if thisStep > 1 or name not in myFilter -%}
                          {%- set preTxt = "<li>" -%}
                          {%- set postTxt = "</li>" -%}
                          {%- set nameTxtStart = "<b>" -%}
                          {%- set NameTxtEnd = "</b>" -%}
                          {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                          {%- if details == thisStep and myDump[0] == "dict" -%}
                            {%- set preTxt = preTxt ~ "<details>" -%}
                            {%- set postTxt = "</details>" ~ postTxt -%}
                            {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                            {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                          {%- endif -%}
                
                          {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is string or dump.val is number -%}
                      {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%} 
                      {%- set dump.valType="string" -%}
                    {%- endif -%}
                  {%- endif -%}
                
                  {%- if thisStep == 1 -%}
                    {{- dump.tmp -}}
                  {%- else -%}
                    {{- [dump.valType, dump.tmp]|to_json -}}
                  {%- endif -%}
                {%- endmacro -%}
                
                {{ "<u>Settings</u><br>" ~ dumpToHTML(mySettings, ["debugg", "weekplanes"], 5, true, 2) }}
                
  
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Weekplans"
              message: '{{ myWeekplanDebugMsg }}'
          
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Settings"
              message: '{{ mySettingsDebugMsg }}'   
          
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Device Commands"
                  message: >-
                    {%- if "deviceCommandsDebug" in mySettings and mySettings.deviceCommandsDebug is mapping -%}
                      {%- for name, commands in mySettings.deviceCommandsDebug.items() -%}
                        <b>{{name}}:</b> {{commands|to_json}}<br>
                      {%- endfor -%}
                    {%- else -%}
                      Keine Device Commands gefunden
                    {%- endif -%}
          
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Statefile State"
                  message: >-
                    statefile.state: {{mySettings.statefile.state if "statefile" in mySettings and "state" in mySettings.statefile else "nicht definiert"}}<br>
                    inp_use_statehelper: {{inp_use_statehelper}}<br>
                    inp_use_statefile: {{inp_use_statefile}}<br>
                    helper exists: {{states(inp_use_statehelper) != "unavailable" if inp_use_statehelper and inp_use_statehelper != "-" else "N/A"}}<br>
                    helper state: {{states(inp_use_statehelper) if inp_use_statehelper and inp_use_statehelper != "-" else "N/A"}}
  
      # Debug: Pfad-Tracking nach Settings
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [1]"
              message: '✅ Settings erfolgreich geladen, starte Device-Verarbeitung'
  
      # Weekplan set next timer    
      - if:
          - condition: template
            value_template: "{{ 'weekplanes' in mySettings and mySettings.weekplanes.next is defined and mySettings.weekplanes.next is number and weekplan_timer and weekplan_timer != '-' and weekplan_timer|length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [2]"
                  message: '✅ Weekplan Timer: Setze Timer auf {{mySettings.weekplanes.next}} Sekunden'
          - action: timer.cancel
            metadata: {}
            data: {}
            target:
              entity_id: "{{weekplan_timer}}"
          - action: timer.start
            metadata: {}
            data:
              duration: "{{mySettings.weekplanes.next}}"
            target:
              entity_id: "{{weekplan_timer}}"
        else:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [2]"
                  message: '⏭️ Weekplan Timer: Bedingung nicht erfüllt (next={{mySettings.weekplanes.next if "weekplanes" in mySettings and "next" in mySettings.weekplanes else "nicht definiert"}}, timer={{weekplan_timer}})'
  
      # write States    
      - if:
          - condition: template
            value_template: "{{ 'statefile' in mySettings and mySettings.statefile.state == 'file' }}"
        then:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [3]"
                  message: '✅ Statefile: Schreibe in Datei {{inp_use_statefile}}'
          - action: shell_command.write_to_file
            data:
              file: "{{- inp_use_statefile -}}"
              txt: >-
                {{- mySettings.statefile.output|replace('"',"\'") -}}
            response_variable: statefile_write
        else:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [3]"
                  message: '⏭️ Statefile (Datei): Bedingung nicht erfüllt (state={{mySettings.statefile.state if "statefile" in mySettings and "state" in mySettings.statefile else "nicht definiert"}})'
      - if:
          - condition: template
            value_template: "{{ 'statefile' in mySettings and mySettings.statefile.state == 'helper' and inp_use_statehelper and inp_use_statehelper != '-' and inp_use_statehelper|length > 0 and mySettings.statefile.output|length <= state_attr(inp_use_statehelper, 'max' )|int }}"
        then:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [4]"
                  message: '✅ Statefile: Schreibe in Helper {{inp_use_statehelper}}'
          - action: input_text.set_value
            metadata: {}
            data:
              value: "{{- mySettings.statefile.output -}}"
            target:
              entity_id: "{{- inp_use_statehelper -}}"
        else:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating - Pfad [4]"
                  message: '⏭️ Statefile (Helper): Bedingung nicht erfüllt (state={{mySettings.statefile.state if "statefile" in mySettings and "state" in mySettings.statefile else "nicht definiert"}}, helper={{inp_use_statehelper}})'
  
      # ########################################################################################################################################
      # DEVICE: HM-IP, SET: programm
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [5]"
              message: '🔍 Prüfe Devices: HM-IP, SET: program'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "equalto", "HmIP")| selectattr("mode", "equalto", "program") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=HmIP | mode=program") }} 
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [6]"
              message: '{{ "✅ HM-IP program: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ HM-IP program: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - variables:
                current_device: '{{  my_devices[repeat.index - 1].device }}'
  
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].deviceID and my_devices[repeat.index - 1].deviceID != '-' and my_devices[repeat.index - 1].deviceID|length > 0 }}"
              then:
                - action: climate.set_hvac_mode
                  metadata: {}
                  data:
                    hvac_mode: auto
                  target:
                    device_id: "{{- my_devices[repeat.index - 1].deviceID -}}"
            - repeat:
                while:
                  - condition: template
                    value_template: '{{"week_program_1" not in state_attr(current_device, "preset_modes")}}'
                  # Don't do it too many times
                  - condition: template
                    value_template: "{{ repeat.index <= 20 }}"
                sequence:
                  - delay:
                      hours: 0
                      minutes: 0
                      seconds: 1
                      milliseconds: 0
          
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].deviceID and my_devices[repeat.index - 1].deviceID != '-' and my_devices[repeat.index - 1].deviceID|length > 0 }}"
              then:
                - action: climate.set_preset_mode
                  alias: set Wochenprogramm
                  data:
                    preset_mode: '{{- "week_program_" ~ my_devices[repeat.index - 1].action -}}'
                  target:
                    device_id: "{{- my_devices[repeat.index - 1].deviceID -}}"
           
            
      # DEVICE: HM, SET: programm                
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [7]"
              message: '🔍 Prüfe Devices: HM, SET: program'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "==", "HM") | selectattr("subdevice", "defined") | selectattr("mode", "==", "program") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=HM | mode=program") }}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [8]"
              message: '{{ "✅ HM program: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ HM program: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].deviceID and my_devices[repeat.index - 1].deviceID != '-' and my_devices[repeat.index - 1].deviceID|length > 0 }}"
              then:
                - action: climate.set_hvac_mode
                  metadata: {}
                  data:
                    hvac_mode: auto
                  target:
                    device_id: "{{- my_devices[repeat.index - 1].deviceID -}}"
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].subdevice and my_devices[repeat.index - 1].subdevice != '-' and my_devices[repeat.index - 1].subdevice|length > 0 }}"
              then:
                - action: select.select_option
                  alias: Wochenprogramm
                  target:
                    device_id: "{{- my_devices[repeat.index - 1].subdevice -}}"
                  data:
                    option: '{{- "week_program_" ~ my_devices[repeat.index - 1].action -}}'
  
      # DEVICE: HM-IP HM, SET: off
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [9]"
              message: '🔍 Prüfe Devices: HM-IP/HM, SET: off'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "match", "^H[Mm].*") | selectattr("mode", "==", "off") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=HM,HmIP | mode=off") }}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [10]"
              message: '{{ "✅ HM-IP/HM off: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ HM-IP/HM off: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - action: climate.turn_off
              metadata: {}
              data: {}
              target:
                entity_id: "{{- my_devices[repeat.index - 1].device -}}"
  
      # DEVICE: HM-IP HM, SET: Temp
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [11]"
              message: '🔍 Prüfe Devices: HM-IP/HM, SET: temp'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "match", "^H[Mm].*") | selectattr("mode", "==", "temp") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=HM,HmIP | mode=temp") }}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [12]"
              message: '{{ "✅ HM-IP/HM temp: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ HM-IP/HM temp: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].device and my_devices[repeat.index - 1].device != '-' and my_devices[repeat.index - 1].device|length > 0 }}"
              then:
                - action: climate.turn_on
                  metadata: {}
                  data: {}
                  target:
                    entity_id: "{{- my_devices[repeat.index - 1].device -}}"
                - if:
                    - condition: template
                      value_template: "{{ state_attr(my_devices[repeat.index - 1].device, 'preset_modes') is defined and state_attr(my_devices[repeat.index - 1].device, 'preset_modes') is iterable and state_attr(my_devices[repeat.index - 1].device, 'preset_modes')|length > 0 }}"
                  then:
                    - action: climate.set_preset_mode
                      metadata: {}
                      data:
                        preset_mode: none
                      target:
                        entity_id: "{{- my_devices[repeat.index - 1].device -}}"
                - action: climate.set_temperature
                  metadata: {}
                  data:
                    temperature: "{{- my_devices[repeat.index - 1].action|string -}}"
                    hvac_mode: heat
                  target:
                    entity_id: "{{- my_devices[repeat.index - 1].device -}}"     
  
  
      # DEVICE: not HM-IP not HM, SET: off
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [13]"
              message: '🔍 Prüfe Devices: Default, SET: off'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "equalto", "-") | selectattr("mode", "equalto", "off") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=default | mode=off") }}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [14]"
              message: '{{ "✅ Default off: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ Default off: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].device and my_devices[repeat.index - 1].device != '-' and my_devices[repeat.index - 1].device|length > 0 }}"
              then:
                - action: climate.turn_off
                  metadata: {}
                  data: {}
                  target:
                    entity_id: "{{- my_devices[repeat.index - 1].device -}}"      
  
      # DEVICE: not HM-IP not HM, SET: Temp
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [15]"
              message: '🔍 Prüfe Devices: Default, SET: temp'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("class", "equalto", "-") | selectattr("mode", "equalto", "temp") | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("class=default | mode=temp") }}
          my_all_devices: '{{ mySettings.devices.climate.values() | list if "climate" in mySettings.devices else [] }}'
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [15] Alle Devices"
              message: >-
                {%- if my_all_devices|length > 0 -%}
                  {%- for device in my_all_devices -%}
                    <b>{{device.name if device.name is defined else "unbekannt"}}:</b><br>
                    &nbsp;&nbsp;class: {{device.class if device.class is defined else "n/a"}}<br>
                    &nbsp;&nbsp;mode: {{device.mode if device.mode is defined else "n/a"}}<br>
                    &nbsp;&nbsp;cmd: {{device.cmd if device.cmd is defined else "n/a"}}<br>
                    &nbsp;&nbsp;action: {{device.action if device.action is defined else "n/a"}}<br>
                    <br>
                  {%- endfor -%}
                {%- else -%}
                  Keine Devices in mySettings.devices.climate gefunden
                {%- endif -%}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [16]"
              message: '{{ "✅ Default temp: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ Default temp: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int}}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ my_devices[repeat.index - 1].device and my_devices[repeat.index - 1].device != '-' and my_devices[repeat.index - 1].device|length > 0 }}"
              then:
                - action: climate.turn_on
                  metadata: {}
                  data: {}
                  target:
                    entity_id: "{{- my_devices[repeat.index - 1].device -}}"
                - if:
                    - condition: template
                      value_template: "{{ state_attr(my_devices[repeat.index - 1].device, 'preset_modes') is defined and state_attr(my_devices[repeat.index - 1].device, 'preset_modes') is iterable and state_attr(my_devices[repeat.index - 1].device, 'preset_modes')|length > 0 }}"
                  then:
                    - action: climate.set_preset_mode
                      metadata: {}
                      data:
                        preset_mode: none
                      target:
                        entity_id: "{{- my_devices[repeat.index - 1].device -}}"
                - action: climate.set_temperature
                  metadata: {}
                  data:
                    temperature: "{{- my_devices[repeat.index - 1].action|string -}}"
                    hvac_mode: heat
                  target:
                    entity_id: "{{- my_devices[repeat.index - 1].device -}}"     
      
      - if:
          - condition: template
            value_template: "{{debugmode and my_devices|length > 0}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [16] Details"
              message: >-
                {%- for device in my_devices -%}
                  <b>{{device.name if device.name is defined else device.device}}:</b><br>
                  &nbsp;&nbsp;cmd: {{device.cmd if device.cmd is defined else "n/a"}}<br>
                  &nbsp;&nbsp;action: {{device.action if device.action is defined else "n/a"}}<br>
                  &nbsp;&nbsp;mode: {{device.mode if device.mode is defined else "n/a"}}<br>
                  &nbsp;&nbsp;device: {{device.device if device.device is defined else "n/a"}}<br>
                  <br>
                {%- endfor -%}
  
      # DEVICE: Overdrivers SET: Temp
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [17]"
              message: '🔍 Prüfe Devices: Overdrivers'
      - variables:
          my_devices: '{{  {} if not "climate" in mySettings.devices else mySettings.devices.climate.values() | selectattr("overdrivers", "defined") | rejectattr("overdrivers", "equalto", "false")  | list }}'
          my_devicesMsg: >-
            {#- ___________________________________________________ -#}
            {%- macro getDevicesMsg(identifier="-") -%} 
              {%- set nsm = namespace() -%}
              {%- set nsm.devices = {} -%}
              {%- if my_devicesMsg is defined and my_devicesMsg is string -%}
                {%- set nsm.msg = my_devicesMsg|from_json -%}
              {%- else -%}
                {%- set nsm.msg = {} -%}
              {%- endif -%}  
              {%- for dev in my_devices -%}
                {%- set nsm.devices = dict(nsm.devices, **{dev.name:dev}) -%}
              {%- endfor -%}
              {%- if nsm.devices | length > 0 -%}
                {%- set nsm.msg = dict(nsm.msg, **{identifier:nsm.devices}) -%}
              {%- endif -%}         
              {{ nsm.msg|to_json }}
            {%- endmacro -%}
            {#- ___________________________________________________ -#}
            {{ getDevicesMsg("set Overdrivers") }}
  
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [18]"
              message: '{{ "✅ Overdrivers: " ~ my_devices|length|string ~ " Device(s) gefunden" if my_devices|length > 0 else "⏭️ Overdrivers: Keine Devices gefunden" }}'
      - repeat:
          count: "{{my_devices|length|int }}"
          sequence:
            - variables:
                counter: "{{- repeat.index -1 -}}"
                drivers: "{{- my_devices[counter].overdrivers -}}"
                temperature: "{{- my_devices[counter].target_temperatur -}}"
            - repeat:
                count: "{{drivers|length|int }}"
                sequence:
                  - variables:
                      driver: "{{- drivers[repeat.index -1 ] -}}"
                  - if:
                      - condition: template
                        value_template: '{{ driver and driver != "-" and driver|length > 0 and driver is search("^input_number\.") }}'
                    then:
                      - action: input_number.set_value
                        metadata: {}
                        data:
                          value: "{{- temperature -}}"
                        target:
                          entity_id: "{{- driver -}}"
      # Debug - Message  Devices    
      - if:
          - condition: template
            value_template: "{{debugmode and my_devicesMsg and my_devicesMsg is string and my_devicesMsg|length > 0}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating"
              message: >-
                {# ___________________________________________________ #}
                {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
                  {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
                  {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}
                
                  {%- set dump = namespace() -%} 
                  {%- set dump.tmp="" -%}
                  {%- set dump.val=val -%}
                  {%- set dump.valType=none -%}
                  {%- set myFilter=filter -%}
                  {%- set filter=[] -%}
                  {%- set thisStep=thisStep + 1 -%}
                  
                  {%- if thisStep > maxSteps -%}
                    {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                    {%- set dump.valType="json" -%}
                  {%- else -%}
                    {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                      {%- set dump.val=dump.val|replace("'", '"')|from_json -%}
                    {%- endif -%}
                    {%- if dump.val is list -%}
                      {%- set dump.valType="list" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for item in dump.val -%}
                        {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                        {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is mapping -%}
                      {%- set dump.valType="dict" -%}
                      {%- set dump.tmp = dump.tmp ~ "<ul>" -%} 
                      {%- for name, item in dump.val.items() -%}
                        {%- if thisStep > 1 or name not in myFilter -%}
                          {%- set preTxt = "<li>" -%}
                          {%- set postTxt = "</li>" -%}
                          {%- set nameTxtStart = "<b>" -%}
                          {%- set NameTxtEnd = "</b>" -%}
                          {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                          {%- if details == thisStep and myDump[0] == "dict" -%}
                            {%- set preTxt = preTxt ~ "<details>" -%}
                            {%- set postTxt = "</details>" ~ postTxt -%}
                            {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                            {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                          {%- endif -%}
                
                          {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- set dump.tmp = dump.tmp ~ "</ul>" -%} 
                    {%- elif dump.val is string or dump.val is number -%}
                      {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%} 
                      {%- set dump.valType="string" -%}
                    {%- endif -%}
                  {%- endif -%}
                
                  {%- if thisStep == 1 -%}
                    {{- dump.tmp -}}
                  {%- else -%}
                    {{- [dump.valType, dump.tmp]|to_json -}}
                  {%- endif -%}
                {%- endmacro -%}
                {{ "modified Devices:" ~ dumpToHTML(my_devicesMsg|from_json, [], 5, true, 2) }}
        else:
          - if:
              - condition: template
                value_template: "{{debugmode}}"
            then:
              - action: notify.persistent_notification
                metadata: {}
                data:
                  title: "Debug TgHeating"
                  message: >-
                    '{{ "debugmode: " ~ debugmode|string ~ " | my_devicesMsg: " ~ (my_devicesMsg|string if my_devicesMsg else "nicht definiert")}}'
  
      # Debug: Abschluss
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [19]"
              message: '✅ Automation erfolgreich abgeschlossen - alle Device-Bereiche durchlaufen'
  
    else:
      - if:
          - condition: template
            value_template: "{{debugmode}}"
        then:
          - action: notify.persistent_notification
            metadata: {}
            data:
              title: "Debug TgHeating - Pfad [ERROR]"
              message: '❌ FEHLER: mySettings ist kein Mapping - Automation abgebrochen'
      - action: notify.persistent_notification
        metadata: {}
        data:
          title: "Debug TgHeating"
          message: "Error in Settings Variable"
  
  
  - if:
      - condition: template
        value_template: "{{debugmode}}"
    then:
  
      - action: notify.persistent_notification
        metadata: {}
        data:
          title: "Debug TgHeating - Output"
          message: '{{ "bis hier ging es gut" }}'   
  

mode: single

